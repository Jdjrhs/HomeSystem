{% extends "base.html" %}

{% block title %}{{ paper.title }} - ArXiv论文详情{% endblock %}

{% block content %}
<!-- 返回按钮 -->
<div class="row mb-3">
    <div class="col">
        <a href="{{ url_for('papers') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回论文列表
        </a>
    </div>
</div>

<!-- 论文详情卡片 -->
<div class="paper-detail">
    <!-- 论文标题和基本信息 -->
    <div class="detail-section">
        <div class="row align-items-start">
            <div class="col-md-9">
                <h1 class="h3 mb-3">{{ paper.title }}</h1>
                
                <!-- 基本信息 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">ArXiv ID</div>
                        <div class="detail-content">
                            <code>{{ paper.arxiv_id }}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                    onclick="copyToClipboard('{{ paper.arxiv_id }}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">分类</div>
                        <div class="detail-content">
                            {% for category in paper.categories.split(',') %}
                            <span class="tag">{{ category | safe_strip }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">发布时间</div>
                        <div class="detail-content">{{ paper.published_date or '未知' }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">添加时间</div>
                        <div class="detail-content">{{ paper.created_at|format_date }}</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 text-end">
                <!-- 状态徽章 -->
                <span class="badge badge-{{ paper.processing_status|status_badge }} fs-6 mb-3">
                    {% if paper.processing_status == 'pending' %}
                        <i class="bi bi-clock"></i> 待处理
                    {% elif paper.processing_status == 'completed' %}
                        <i class="bi bi-check-circle"></i> 已完成
                    {% elif paper.processing_status == 'failed' %}
                        <i class="bi bi-x-circle"></i> 失败
                    {% endif %}
                </span>
                
                <!-- 操作按钮 -->
                <div class="d-grid gap-2">
                    {% if paper.pdf_url %}
                    <a href="{{ paper.pdf_url }}" target="_blank" class="btn btn-primary">
                        <i class="bi bi-file-pdf"></i> 查看PDF
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-info" onclick="copyToClipboard(window.location.href)">
                        <i class="bi bi-share"></i> 分享链接
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportPaperData()">
                        <i class="bi bi-download"></i> 导出数据
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 作者信息 -->
    {% if paper.authors %}
    <div class="detail-section">
        <div class="detail-label">作者</div>
        <div class="detail-content">{{ paper.authors }}</div>
    </div>
    {% endif %}
    
    <!-- 论文摘要 -->
    {% if paper.abstract %}
    <div class="detail-section">
        <div class="detail-label">摘要</div>
        <div class="detail-content markdown-content">{{ paper.abstract|markdown|safe }}</div>
    </div>
    {% endif %}
    
    <!-- 相关度评分 -->
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-star"></i>
                    相关度评分
                    <button class="btn btn-sm btn-outline-primary float-end" onclick="editRelevance('{{ paper.arxiv_id }}')">
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">评分</div>
                        <div class="detail-content" id="relevance-score-display">
                            {% if paper.full_paper_relevance_score is not none %}
                                {{ paper.full_paper_relevance_score|relevance_score_stars|safe }} 
                                <strong>({{ paper.full_paper_relevance_score|relevance_score_display }})</strong>
                            {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-question-circle"></i> 未评分
                                    <button class="btn btn-sm btn-outline-info ms-2" onclick="editRelevance('{{ paper.arxiv_id }}')">
                                        点击评分
                                    </button>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">状态</div>
                        <div class="detail-content">
                            {{ paper|relevance_status_badge|safe }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="detail-label">评分理由</div>
                        <div class="detail-content markdown-content" id="relevance-justification-display">
                            {% if paper.full_paper_relevance_justification %}
                                {{ paper.full_paper_relevance_justification|markdown|safe }}
                            {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-chat-text"></i> 暂无评分理由
                                    <button class="btn btn-sm btn-outline-info ms-2" onclick="editRelevance('{{ paper.arxiv_id }}')">
                                        添加理由
                                    </button>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 结构化分析 -->
    {% if paper.research_background or paper.research_objectives or paper.methods or paper.key_findings or paper.conclusions or paper.limitations or paper.future_work %}
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i>
                    结构化分析
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if paper.research_background %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究背景</div>
                        <div class="detail-content markdown-content">{{ paper.research_background|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.research_objectives %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究目标</div>
                        <div class="detail-content markdown-content">{{ paper.research_objectives|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.methods %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究方法</div>
                        <div class="detail-content markdown-content">{{ paper.methods|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.key_findings %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">主要发现</div>
                        <div class="detail-content markdown-content">{{ paper.key_findings|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.conclusions %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">结论</div>
                        <div class="detail-content markdown-content">{{ paper.conclusions|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.limitations %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">局限性</div>
                        <div class="detail-content markdown-content">{{ paper.limitations|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.future_work %}
                    <div class="col-md-12 mb-3">
                        <div class="detail-label">未来工作</div>
                        <div class="detail-content markdown-content">{{ paper.future_work|markdown|safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 关键词 -->
    {% if paper.keywords %}
    <div class="detail-section">
        <div class="detail-label">关键词</div>
        <div class="detail-content">
            {% for keyword in paper.keywords.split(',') %}
            <span class="tag">{{ keyword | safe_strip }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 标签 -->
    {% if paper.tags %}
    <div class="detail-section">
        <div class="detail-label">标签</div>
        <div class="detail-content">
            {% for tag in paper.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 元数据 -->
    {% if paper.metadata %}
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    元数据
                    <button class="btn btn-sm btn-outline-secondary float-end" 
                            type="button" data-bs-toggle="collapse" 
                            data-bs-target="#metadataCollapse">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h6>
            </div>
            <div class="collapse" id="metadataCollapse">
                <div class="card-body">
                    <pre class="bg-light p-3"><code>{{ paper.metadata|tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 时间信息 -->
    <div class="detail-section">
        <div class="row text-muted">
            <div class="col-md-6">
                <small>
                    <i class="bi bi-calendar-plus"></i>
                    创建时间: {{ paper.created_at|format_date }}
                </small>
            </div>
            <div class="col-md-6 text-md-end">
                <small>
                    <i class="bi bi-calendar-event"></i>
                    更新时间: {{ paper.updated_at|format_date }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- 相关操作 -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-link-45deg"></i>
                    相关操作
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('papers', category=(paper.categories.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-tag"></i>
                            查看同类论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('papers', q=(paper.authors.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-person"></i>
                            查看同作者论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        {% if paper.keywords %}
                        <a href="{{ url_for('papers', q=(paper.keywords.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-key"></i>
                            查看相关关键词
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                            <i class="bi bi-key"></i>
                            无关键词数据
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 相关度编辑模态框 -->
<div class="modal fade" id="relevanceEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-star"></i>
                    编辑相关度评分
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="relevanceEditForm">
                    <input type="hidden" id="edit-arxiv-id" value="{{ paper.arxiv_id }}">
                    
                    <!-- 评分输入 -->
                    <div class="mb-4">
                        <label for="relevance-score-input" class="form-label">
                            相关度评分 (0.00-1.00)
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" class="form-control" id="relevance-score-input"
                                       min="0" max="1" step="0.01" 
                                       placeholder="请输入0.00-1.00之间的数值"
                                       value="{{ paper.full_paper_relevance_score or '' }}">
                                <div class="form-text">输入相关度评分，1.00表示高度相关，0.00表示不相关</div>
                            </div>
                            <div class="col-md-6">
                                <div class="mt-2">
                                    <span id="score-preview" class="fs-5"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 快捷评分按钮 -->
                        <div class="mt-3">
                            <label class="form-label">快捷评分</label>
                            <div class="btn-group d-block" role="group">
                                <button type="button" class="btn btn-success btn-sm me-2" data-score="0.9">
                                    高相关 (0.9)
                                </button>
                                <button type="button" class="btn btn-warning btn-sm me-2" data-score="0.7">
                                    中相关 (0.7)
                                </button>
                                <button type="button" class="btn btn-info btn-sm me-2" data-score="0.5">
                                    一般 (0.5)
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm me-2" data-score="0.3">
                                    低相关 (0.3)
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" data-score="0.1">
                                    不相关 (0.1)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 理由编辑 -->
                    <div class="mb-4">
                        <label for="relevance-justification-input" class="form-label">
                            相关度理由
                        </label>
                        <textarea class="form-control" id="relevance-justification-input" 
                                  rows="6" maxlength="5000"
                                  placeholder="请描述该论文与研究需求的相关性，包括相关的研究方向、方法、应用场景等...">{{ paper.full_paper_relevance_justification or '' }}</textarea>
                        <div class="form-text">
                            <span id="char-count">0</span>/5000 字符
                            <span class="ms-3">建议包含：相关的研究方向、方法、应用场景等</span>
                        </div>
                        
                        <!-- 理由模板 -->
                        <div class="mt-3">
                            <label class="form-label">常用理由模板</label>
                            <div class="btn-group d-block" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" data-template="method">
                                    方法相关
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" data-template="domain">
                                    领域相关
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" data-template="application">
                                    应用相关
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-template="irrelevant">
                                    不相关
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 保存状态 -->
                    <div class="alert alert-info d-none" id="save-status">
                        <i class="bi bi-info-circle"></i>
                        <span id="save-message"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" id="save-relevance-btn">
                    <i class="bi bi-check-circle"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // 相关度编辑功能
    function editRelevance(arxivId) {
        $('#edit-arxiv-id').val(arxivId);
        updateCharCount();
        updateScorePreview();
        $('#relevanceEditModal').modal('show');
    }
    
    // 更新评分预览
    function updateScorePreview() {
        const score = parseFloat($('#relevance-score-input').val());
        const preview = $('#score-preview');
        
        if (isNaN(score) || score < 0 || score > 1) {
            preview.html('<span class="text-muted">☆☆☆☆☆</span>');
            return;
        }
        
        const starsCount = Math.round(score * 5);
        const filledStars = '★'.repeat(starsCount);
        const emptyStars = '☆'.repeat(5 - starsCount);
        
        let colorClass;
        if (score >= 0.8) colorClass = 'text-success';
        else if (score >= 0.5) colorClass = 'text-warning';
        else colorClass = 'text-danger';
        
        preview.html(`<span class="${colorClass}">${filledStars}${emptyStars}</span> (${score.toFixed(2)})`);
    }
    
    // 更新字符计数
    function updateCharCount() {
        const text = $('#relevance-justification-input').val();
        $('#char-count').text(text.length);
    }
    
    // 理由模板
    const templates = {
        method: "该论文提出的方法与我们的研究方向高度相关，可以作为重要参考。",
        domain: "论文涉及的研究领域与当前项目需求匹配，具有较好的参考价值。",
        application: "论文中的应用场景与我们的目标应用相似，可提供有用的实践经验。",
        irrelevant: "经过分析，该论文与当前研究需求相关性较低，不符合项目要求。"
    };
    
    // 保存相关度
    function saveRelevance() {
        const arxivId = $('#edit-arxiv-id').val();
        const score = $('#relevance-score-input').val();
        const justification = $('#relevance-justification-input').val().trim();
        
        // 验证输入
        if (!score && !justification) {
            showSaveStatus('error', '请至少填写评分或理由');
            return;
        }
        
        if (score && (parseFloat(score) < 0 || parseFloat(score) > 1)) {
            showSaveStatus('error', '评分必须在0-1之间');
            return;
        }
        
        const saveBtn = $('#save-relevance-btn');
        const originalText = saveBtn.html();
        saveBtn.html('<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> 保存中...').prop('disabled', true);
        
        // 准备数据
        const data = {
            arxiv_id: arxivId
        };
        
        if (score) {
            data.relevance_score = parseFloat(score);
        }
        
        if (justification) {
            data.relevance_justification = justification;
        }
        
        // 发送请求
        $.ajax({
            url: '/api/update_relevance',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showSaveStatus('success', '保存成功！页面将刷新...');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showSaveStatus('error', response.error || '保存失败');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '网络错误，请稍后重试';
                showSaveStatus('error', error);
            },
            complete: function() {
                saveBtn.html(originalText).prop('disabled', false);
            }
        });
    }
    
    // 显示保存状态
    function showSaveStatus(type, message) {
        const statusDiv = $('#save-status');
        const messageSpan = $('#save-message');
        
        statusDiv.removeClass('alert-info alert-success alert-danger d-none');
        
        if (type === 'success') {
            statusDiv.addClass('alert-success');
            messageSpan.html(`<i class="bi bi-check-circle"></i> ${message}`);
        } else if (type === 'error') {
            statusDiv.addClass('alert-danger');
            messageSpan.html(`<i class="bi bi-exclamation-triangle"></i> ${message}`);
        } else {
            statusDiv.addClass('alert-info');
            messageSpan.html(`<i class="bi bi-info-circle"></i> ${message}`);
        }
    }
    
    // 页面加载完成后的事件绑定
    $(document).ready(function() {
        // 快捷评分按钮点击事件
        $('[data-score]').click(function() {
            const score = $(this).data('score');
            $('#relevance-score-input').val(score);
            updateScorePreview();
        });
        
        // 理由模板按钮点击事件
        $('[data-template]').click(function() {
            const template = $(this).data('template');
            const textarea = $('#relevance-justification-input');
            const currentText = textarea.val().trim();
            const templateText = templates[template];
            
            if (currentText && !confirm('这将替换当前的理由内容，确定继续吗？')) {
                return;
            }
            
            textarea.val(templateText);
            updateCharCount();
        });
        
        // 评分输入变化事件
        $('#relevance-score-input').on('input', function() {
            updateScorePreview();
        });
        
        // 理由文本变化事件
        $('#relevance-justification-input').on('input', function() {
            updateCharCount();
        });
        
        // 保存按钮点击事件
        $('#save-relevance-btn').click(function() {
            saveRelevance();
        });
        
        // 键盘快捷键
        $('#relevanceEditModal').on('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveRelevance();
            }
        });
    });

    // 导出论文数据
    function exportPaperData() {
        const paperData = {
            arxiv_id: '{{ paper.arxiv_id }}',
            title: '{{ paper.title|e }}',
            authors: '{{ paper.authors|e }}',
            abstract: '{{ paper.abstract|e }}',
            categories: '{{ paper.categories }}',
            published_date: '{{ paper.published_date }}',
            pdf_url: '{{ paper.pdf_url }}',
            processing_status: '{{ paper.processing_status }}',
            research_background: '{{ paper.research_background|e }}',
            research_objectives: '{{ paper.research_objectives|e }}',
            methods: '{{ paper.methods|e }}',
            key_findings: '{{ paper.key_findings|e }}',
            conclusions: '{{ paper.conclusions|e }}',
            limitations: '{{ paper.limitations|e }}',
            future_work: '{{ paper.future_work|e }}',
            keywords: '{{ paper.keywords|e }}',
            tags: {{ paper.tags|tojson }},
            metadata: {{ paper.metadata|tojson }},
            created_at: '{{ paper.created_at }}',
            updated_at: '{{ paper.updated_at }}'
        };
        
        const dataStr = JSON.stringify(paperData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${paperData.arxiv_id}_data.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('论文数据已导出', 'success');
    }
    
    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // ESC 键返回列表
        if (e.key === 'Escape') {
            window.location.href = '{{ url_for("papers") }}';
        }
        
        // P 键打开PDF（如果有）
        if (e.key === 'p' || e.key === 'P') {
            {% if paper.pdf_url %}
            window.open('{{ paper.pdf_url }}', '_blank');
            {% endif %}
        }
    });
    
    // 页面加载完成后的处理
    document.addEventListener('DOMContentLoaded', function() {
        // 长文本自动展开/折叠功能
        const longTexts = document.querySelectorAll('.detail-content');
        longTexts.forEach(function(element) {
            if (element.textContent.length > 500) {
                element.style.maxHeight = '150px';
                element.style.overflow = 'hidden';
                element.style.position = 'relative';
                
                const expandBtn = document.createElement('button');
                expandBtn.className = 'btn btn-sm btn-link p-0 mt-2';
                expandBtn.innerHTML = '<i class="bi bi-chevron-down"></i> 显示更多';
                expandBtn.onclick = function() {
                    if (element.style.maxHeight === '150px') {
                        element.style.maxHeight = 'none';
                        this.innerHTML = '<i class="bi bi-chevron-up"></i> 显示较少';
                    } else {
                        element.style.maxHeight = '150px';
                        this.innerHTML = '<i class="bi bi-chevron-down"></i> 显示更多';
                    }
                };
                
                element.parentNode.appendChild(expandBtn);
            }
        });
    });
</script>
{% endblock %}