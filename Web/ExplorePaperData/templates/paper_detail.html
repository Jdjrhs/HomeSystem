{% extends "base.html" %}

{% block title %}{{ paper.title }} - ArXiv论文详情{% endblock %}

{% block content %}
<!-- 导航按钮组 -->
<div class="row mb-3">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <!-- 左侧：返回按钮 -->
            <a href="{{ url_for('papers') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回论文列表
            </a>
            
            <!-- 中间：论文导航按钮 -->
            <div class="btn-group" role="group" aria-label="论文导航">
                {% if navigation.previous %}
                <a href="{{ url_for('paper_detail', arxiv_id=navigation.previous.arxiv_id) }}" 
                   class="btn btn-outline-primary" id="prev-paper-btn"
                   title="{{ navigation.previous.title | truncate_text(50) }}">
                    <i class="bi bi-chevron-left"></i> 上一篇
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled title="已是第一篇论文">
                    <i class="bi bi-chevron-left"></i> 上一篇
                </button>
                {% endif %}
                
                {% if navigation.next %}
                <a href="{{ url_for('paper_detail', arxiv_id=navigation.next.arxiv_id) }}" 
                   class="btn btn-outline-primary" id="next-paper-btn"
                   title="{{ navigation.next.title | truncate_text(50) }}">
                    下一篇 <i class="bi bi-chevron-right"></i>
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled title="已是最后一篇论文">
                    下一篇 <i class="bi bi-chevron-right"></i>
                </button>
                {% endif %}
            </div>
            
            <!-- 右侧：快捷键提示 -->
            <small class="text-muted d-none d-md-block">
                <i class="bi bi-keyboard"></i> 
                使用 ← → 键导航
            </small>
        </div>
    </div>
</div>

<!-- 论文详情卡片 -->
<div class="paper-detail">
    <!-- 论文标题和基本信息 -->
    <div class="detail-section">
        <div class="row align-items-start">
            <div class="col-md-9">
                <h1 class="h3 mb-3">{{ paper.title }}</h1>
                
                <!-- 基本信息 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">ArXiv ID</div>
                        <div class="detail-content">
                            <code>{{ paper.arxiv_id }}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                    onclick="copyToClipboard('{{ paper.arxiv_id }}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">分类</div>
                        <div class="detail-content">
                            {% for category in paper.categories.split(',') %}
                            <span class="tag">{{ category | safe_strip }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">发布时间</div>
                        <div class="detail-content">{{ paper.published_date or '未知' }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">添加时间</div>
                        <div class="detail-content">{{ paper.created_at|format_date }}</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 text-end">
                <!-- 状态徽章 -->
                <span class="badge badge-{{ paper.processing_status|status_badge }} fs-6 mb-3">
                    {% if paper.processing_status == 'pending' %}
                        <i class="bi bi-clock"></i> 待处理
                    {% elif paper.processing_status == 'completed' %}
                        <i class="bi bi-check-circle"></i> 已完成
                    {% elif paper.processing_status == 'failed' %}
                        <i class="bi bi-x-circle"></i> 失败
                    {% endif %}
                </span>
                
                <!-- 操作按钮 -->
                <div class="d-grid gap-2">
                    {% if paper.pdf_url %}
                    <a href="{{ paper.pdf_url }}" target="_blank" class="btn btn-primary">
                        <i class="bi bi-file-pdf"></i> 查看PDF
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-warning" onclick="openMigrationModal('{{ paper.arxiv_id }}', '{{ paper.title | e }}')">
                        <i class="bi bi-arrow-right-circle"></i> 迁移任务
                    </button>
                    <button class="btn btn-outline-info" onclick="copyToClipboard(window.location.href)">
                        <i class="bi bi-share"></i> 分享链接
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportPaperData()">
                        <i class="bi bi-download"></i> 导出数据
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 作者信息 -->
    {% if paper.authors %}
    <div class="detail-section">
        <div class="detail-label">作者</div>
        <div class="detail-content">{{ paper.authors }}</div>
    </div>
    {% endif %}
    
    <!-- 论文摘要 -->
    {% if paper.abstract %}
    <div class="detail-section">
        <div class="detail-label">摘要</div>
        <div class="detail-content markdown-content">{{ paper.abstract|markdown|safe }}</div>
    </div>
    {% endif %}
    
    <!-- 相关度评分 -->
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-star"></i>
                    相关度评分
                    <button class="btn btn-sm btn-outline-primary float-end" onclick="editRelevance('{{ paper.arxiv_id }}')">
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">评分</div>
                        <div class="detail-content" id="relevance-score-display">
                            {% if paper.full_paper_relevance_score is not none %}
                                {{ paper.full_paper_relevance_score|relevance_score_stars|safe }} 
                                <strong>({{ paper.full_paper_relevance_score|relevance_score_display }})</strong>
                            {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-question-circle"></i> 未评分
                                    <button class="btn btn-sm btn-outline-info ms-2" onclick="editRelevance('{{ paper.arxiv_id }}')">
                                        点击评分
                                    </button>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">状态</div>
                        <div class="detail-content">
                            {{ paper|relevance_status_badge|safe }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="detail-label">评分理由</div>
                        <div class="detail-content markdown-content" id="relevance-justification-display">
                            {% if paper.full_paper_relevance_justification %}
                                {{ paper.full_paper_relevance_justification|markdown|safe }}
                            {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-chat-text"></i> 暂无评分理由
                                    <button class="btn btn-sm btn-outline-info ms-2" onclick="editRelevance('{{ paper.arxiv_id }}')">
                                        添加理由
                                    </button>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 结构化分析 -->
    {% if paper.research_background or paper.research_objectives or paper.methods or paper.key_findings or paper.conclusions or paper.limitations or paper.future_work %}
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i>
                    结构化分析
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if paper.research_background %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究背景</div>
                        <div class="detail-content markdown-content">{{ paper.research_background|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.research_objectives %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究目标</div>
                        <div class="detail-content markdown-content">{{ paper.research_objectives|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.methods %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究方法</div>
                        <div class="detail-content markdown-content">{{ paper.methods|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.key_findings %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">主要发现</div>
                        <div class="detail-content markdown-content">{{ paper.key_findings|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.conclusions %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">结论</div>
                        <div class="detail-content markdown-content">{{ paper.conclusions|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.limitations %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">局限性</div>
                        <div class="detail-content markdown-content">{{ paper.limitations|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.future_work %}
                    <div class="col-md-12 mb-3">
                        <div class="detail-label">未来工作</div>
                        <div class="detail-content markdown-content">{{ paper.future_work|markdown|safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 关键词 -->
    {% if paper.keywords %}
    <div class="detail-section">
        <div class="detail-label">关键词</div>
        <div class="detail-content">
            {% for keyword in paper.keywords.split(',') %}
            <span class="tag">{{ keyword | safe_strip }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 标签 -->
    {% if paper.tags %}
    <div class="detail-section">
        <div class="detail-label">标签</div>
        <div class="detail-content">
            {% for tag in paper.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 元数据 -->
    {% if paper.metadata %}
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    元数据
                    <button class="btn btn-sm btn-outline-secondary float-end" 
                            type="button" data-bs-toggle="collapse" 
                            data-bs-target="#metadataCollapse">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h6>
            </div>
            <div class="collapse" id="metadataCollapse">
                <div class="card-body">
                    <pre class="bg-light p-3"><code>{{ paper.metadata|tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 时间信息 -->
    <div class="detail-section">
        <div class="row text-muted">
            <div class="col-md-6">
                <small>
                    <i class="bi bi-calendar-plus"></i>
                    创建时间: {{ paper.created_at|format_date }}
                </small>
            </div>
            <div class="col-md-6 text-md-end">
                <small>
                    <i class="bi bi-calendar-event"></i>
                    更新时间: {{ paper.updated_at|format_date }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- 相关操作 -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-link-45deg"></i>
                    相关操作
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('papers', category=(paper.categories.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-tag"></i>
                            查看同类论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('papers', q=(paper.authors.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-person"></i>
                            查看同作者论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        {% if paper.keywords %}
                        <a href="{{ url_for('papers', q=(paper.keywords.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-key"></i>
                            查看相关关键词
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                            <i class="bi bi-key"></i>
                            无关键词数据
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 相关度编辑模态框 -->
<div class="modal fade" id="relevanceEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-star"></i>
                    编辑相关度评分
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="relevanceEditForm">
                    <input type="hidden" id="edit-arxiv-id" value="{{ paper.arxiv_id }}">
                    
                    <!-- 评分输入 -->
                    <div class="mb-4">
                        <label for="relevance-score-input" class="form-label">
                            相关度评分 (0.00-1.00)
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" class="form-control" id="relevance-score-input"
                                       min="0" max="1" step="0.01" 
                                       placeholder="请输入0.00-1.00之间的数值"
                                       value="{{ paper.full_paper_relevance_score or '' }}">
                                <div class="form-text">输入相关度评分，1.00表示高度相关，0.00表示不相关</div>
                            </div>
                            <div class="col-md-6">
                                <div class="mt-2">
                                    <span id="score-preview" class="fs-5"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 快捷评分按钮 -->
                        <div class="mt-3">
                            <label class="form-label">快捷评分</label>
                            <div class="btn-group d-block" role="group">
                                <button type="button" class="btn btn-success btn-sm me-2" data-score="0.9">
                                    高相关 (0.9)
                                </button>
                                <button type="button" class="btn btn-warning btn-sm me-2" data-score="0.7">
                                    中相关 (0.7)
                                </button>
                                <button type="button" class="btn btn-info btn-sm me-2" data-score="0.5">
                                    一般 (0.5)
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm me-2" data-score="0.3">
                                    低相关 (0.3)
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" data-score="0.1">
                                    不相关 (0.1)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 理由编辑 -->
                    <div class="mb-4">
                        <label for="relevance-justification-input" class="form-label">
                            相关度理由
                        </label>
                        <textarea class="form-control" id="relevance-justification-input" 
                                  rows="6" maxlength="5000"
                                  placeholder="请描述该论文与研究需求的相关性，包括相关的研究方向、方法、应用场景等...">{{ paper.full_paper_relevance_justification or '' }}</textarea>
                        <div class="form-text">
                            <span id="char-count">0</span>/5000 字符
                            <span class="ms-3">建议包含：相关的研究方向、方法、应用场景等</span>
                        </div>
                        
                        <!-- 理由模板 -->
                        <div class="mt-3">
                            <label class="form-label">常用理由模板</label>
                            <div class="btn-group d-block" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" data-template="method">
                                    方法相关
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" data-template="domain">
                                    领域相关
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" data-template="application">
                                    应用相关
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-template="irrelevant">
                                    不相关
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 保存状态 -->
                    <div class="alert alert-info d-none" id="save-status">
                        <i class="bi bi-info-circle"></i>
                        <span id="save-message"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" id="save-relevance-btn">
                    <i class="bi bi-check-circle"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务迁移模态框 -->
<div class="modal fade" id="migrationModal" tabindex="-1" aria-labelledby="migrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="migrationModalLabel">
                    <i class="bi bi-arrow-right-circle"></i> 迁移到已有任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>论文:</strong> <span id="migrationPaperTitle"></span>
                </div>
                
                <!-- 任务搜索 -->
                <div class="mb-3">
                    <label for="taskSearchInput" class="form-label">搜索任务</label>
                    <input type="text" class="form-control" id="taskSearchInput" 
                           placeholder="输入任务名称进行搜索..." 
                           onkeyup="filterTasks()">
                </div>
                
                <!-- 任务列表 -->
                <div id="taskListContainer" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载任务列表...</p>
                    </div>
                </div>
                
                <!-- 迁移状态显示 -->
                <div id="migrationStatus" class="alert d-none mt-3" role="alert">
                    <span id="migrationStatusMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="confirmMigrationBtn" onclick="confirmMigration()" disabled>
                    <i class="bi bi-check-circle"></i> 确认迁移
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<style>
    .cursor-pointer {
        cursor: pointer;
    }
    
    .task-option {
        transition: all 0.2s ease;
    }
    
    .task-option:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .task-option.border-primary {
        border-width: 2px !important;
    }
</style>
<script>
    // 相关度编辑功能
    function editRelevance(arxivId) {
        $('#edit-arxiv-id').val(arxivId);
        updateCharCount();
        updateScorePreview();
        $('#relevanceEditModal').modal('show');
    }
    
    // 更新评分预览
    function updateScorePreview() {
        const score = parseFloat($('#relevance-score-input').val());
        const preview = $('#score-preview');
        
        if (isNaN(score) || score < 0 || score > 1) {
            preview.html('<span class="text-muted">☆☆☆☆☆</span>');
            return;
        }
        
        const starsCount = Math.round(score * 5);
        const filledStars = '★'.repeat(starsCount);
        const emptyStars = '☆'.repeat(5 - starsCount);
        
        let colorClass;
        if (score >= 0.8) colorClass = 'text-success';
        else if (score >= 0.5) colorClass = 'text-warning';
        else colorClass = 'text-danger';
        
        preview.html(`<span class="${colorClass}">${filledStars}${emptyStars}</span> (${score.toFixed(2)})`);
    }
    
    // 更新字符计数
    function updateCharCount() {
        const text = $('#relevance-justification-input').val();
        $('#char-count').text(text.length);
    }
    
    // 理由模板
    const templates = {
        method: "该论文提出的方法与我们的研究方向高度相关，可以作为重要参考。",
        domain: "论文涉及的研究领域与当前项目需求匹配，具有较好的参考价值。",
        application: "论文中的应用场景与我们的目标应用相似，可提供有用的实践经验。",
        irrelevant: "经过分析，该论文与当前研究需求相关性较低，不符合项目要求。"
    };
    
    // 保存相关度
    function saveRelevance() {
        const arxivId = $('#edit-arxiv-id').val();
        const score = $('#relevance-score-input').val();
        const justification = $('#relevance-justification-input').val().trim();
        
        // 验证输入
        if (!score && !justification) {
            showSaveStatus('error', '请至少填写评分或理由');
            return;
        }
        
        if (score && (parseFloat(score) < 0 || parseFloat(score) > 1)) {
            showSaveStatus('error', '评分必须在0-1之间');
            return;
        }
        
        const saveBtn = $('#save-relevance-btn');
        const originalText = saveBtn.html();
        saveBtn.html('<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> 保存中...').prop('disabled', true);
        
        // 准备数据
        const data = {
            arxiv_id: arxivId
        };
        
        if (score) {
            data.relevance_score = parseFloat(score);
        }
        
        if (justification) {
            data.relevance_justification = justification;
        }
        
        // 发送请求
        $.ajax({
            url: '/api/update_relevance',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showSaveStatus('success', '保存成功！页面将刷新...');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showSaveStatus('error', response.error || '保存失败');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '网络错误，请稍后重试';
                showSaveStatus('error', error);
            },
            complete: function() {
                saveBtn.html(originalText).prop('disabled', false);
            }
        });
    }
    
    // 显示保存状态
    function showSaveStatus(type, message) {
        const statusDiv = $('#save-status');
        const messageSpan = $('#save-message');
        
        statusDiv.removeClass('alert-info alert-success alert-danger d-none');
        
        if (type === 'success') {
            statusDiv.addClass('alert-success');
            messageSpan.html(`<i class="bi bi-check-circle"></i> ${message}`);
        } else if (type === 'error') {
            statusDiv.addClass('alert-danger');
            messageSpan.html(`<i class="bi bi-exclamation-triangle"></i> ${message}`);
        } else {
            statusDiv.addClass('alert-info');
            messageSpan.html(`<i class="bi bi-info-circle"></i> ${message}`);
        }
    }
    
    // 页面加载完成后的事件绑定
    $(document).ready(function() {
        // 快捷评分按钮点击事件
        $('[data-score]').click(function() {
            const score = $(this).data('score');
            $('#relevance-score-input').val(score);
            updateScorePreview();
        });
        
        // 理由模板按钮点击事件
        $('[data-template]').click(function() {
            const template = $(this).data('template');
            const textarea = $('#relevance-justification-input');
            const currentText = textarea.val().trim();
            const templateText = templates[template];
            
            if (currentText && !confirm('这将替换当前的理由内容，确定继续吗？')) {
                return;
            }
            
            textarea.val(templateText);
            updateCharCount();
        });
        
        // 评分输入变化事件
        $('#relevance-score-input').on('input', function() {
            updateScorePreview();
        });
        
        // 理由文本变化事件
        $('#relevance-justification-input').on('input', function() {
            updateCharCount();
        });
        
        // 保存按钮点击事件
        $('#save-relevance-btn').click(function() {
            saveRelevance();
        });
        
        // 键盘快捷键
        $('#relevanceEditModal').on('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveRelevance();
            }
        });
    });

    // 导出论文数据
    function exportPaperData() {
        const paperData = {
            arxiv_id: '{{ paper.arxiv_id }}',
            title: '{{ paper.title|e }}',
            authors: '{{ paper.authors|e }}',
            abstract: '{{ paper.abstract|e }}',
            categories: '{{ paper.categories }}',
            published_date: '{{ paper.published_date }}',
            pdf_url: '{{ paper.pdf_url }}',
            processing_status: '{{ paper.processing_status }}',
            research_background: '{{ paper.research_background|e }}',
            research_objectives: '{{ paper.research_objectives|e }}',
            methods: '{{ paper.methods|e }}',
            key_findings: '{{ paper.key_findings|e }}',
            conclusions: '{{ paper.conclusions|e }}',
            limitations: '{{ paper.limitations|e }}',
            future_work: '{{ paper.future_work|e }}',
            keywords: '{{ paper.keywords|e }}',
            tags: {{ paper.tags|tojson }},
            metadata: {{ paper.metadata|tojson }},
            created_at: '{{ paper.created_at }}',
            updated_at: '{{ paper.updated_at }}'
        };
        
        const dataStr = JSON.stringify(paperData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${paperData.arxiv_id}_data.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('论文数据已导出', 'success');
    }
    
    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // 如果正在编辑相关度模态框，不处理导航快捷键
        if (document.getElementById('relevanceEditModal').classList.contains('show')) {
            return;
        }
        
        // ESC 键返回列表
        if (e.key === 'Escape') {
            window.location.href = '{{ url_for("papers") }}';
        }
        
        // P 键打开PDF（如果有）
        if (e.key === 'p' || e.key === 'P') {
            {% if paper.pdf_url %}
            window.open('{{ paper.pdf_url }}', '_blank');
            {% endif %}
        }
        
        // 左箭头键：上一篇论文
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            {% if navigation.previous %}
            window.location.href = '{{ url_for("paper_detail", arxiv_id=navigation.previous.arxiv_id) }}';
            {% else %}
            showAlert('已是第一篇论文', 'info');
            {% endif %}
        }
        
        // 右箭头键：下一篇论文
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            {% if navigation.next %}
            window.location.href = '{{ url_for("paper_detail", arxiv_id=navigation.next.arxiv_id) }}';
            {% else %}
            showAlert('已是最后一篇论文', 'info');
            {% endif %}
        }
    });
    
    // 任务迁移相关变量
    let availableTasks = [];
    let filteredTasks = [];
    let selectedTaskForMigration = null;
    
    // 打开迁移模态框
    function openMigrationModal(arxivId, paperTitle) {
        document.getElementById('migrationPaperTitle').textContent = paperTitle;
        
        // 存储当前论文的arxiv_id
        window.currentMigrationArxivId = arxivId;
        
        // 重置状态
        selectedTaskForMigration = null;
        document.getElementById('confirmMigrationBtn').disabled = true;
        hideMigrationStatus();
        
        // 加载任务列表
        loadTasksForMigration();
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('migrationModal'));
        modal.show();
    }
    
    // 加载可用于迁移的任务
    function loadTasksForMigration() {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载任务列表...</p>
            </div>
        `;
        
        fetch('/api/tasks/available_for_migration')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    availableTasks = data.data.tasks || [];
                    filteredTasks = [...availableTasks];
                    renderTaskList();
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            加载任务列表失败: ${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('加载任务列表失败:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        网络错误，请检查网络连接后重试
                    </div>
                `;
            });
    }
    
    // 渲染任务列表
    function renderTaskList() {
        const container = document.getElementById('taskListContainer');
        
        if (filteredTasks.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    ${availableTasks.length === 0 ? '暂无可用任务' : '搜索结果为空'}
                </div>
            `;
            return;
        }
        
        const tasksHtml = filteredTasks.map(task => `
            <div class="task-option border rounded p-3 mb-2 cursor-pointer" data-task='${JSON.stringify(task)}'>
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <strong>${escapeHtml(task.task_name)}</strong>
                            ${task.task_id ? `<span class="text-muted small">(${escapeHtml(task.task_id)})</span>` : ''}
                        </h6>
                        <div class="small text-muted">
                            <i class="bi bi-file-text"></i> ${task.paper_count || 0} 篇论文
                            ${task.top_categories && task.top_categories.length > 0 ? 
                                `<span class="ms-2"><i class="bi bi-tags"></i> ${task.top_categories.slice(0, 3).map(cat => escapeHtml(cat)).join(', ')}</span>` 
                                : ''
                            }
                        </div>
                        ${task.created_at ? `<div class="small text-muted mt-1"><i class="bi bi-calendar"></i> ${formatDate(task.created_at)}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <button class="btn btn-outline-primary btn-sm select-task-btn">选择</button>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = tasksHtml;
        
        // 添加点击事件监听器
        container.querySelectorAll('.task-option').forEach(taskElement => {
            taskElement.addEventListener('click', function() {
                selectTaskForMigration(this);
            });
        });
    }
    
    // 选择任务
    function selectTaskForMigration(taskElement) {
        // 清除之前的选择
        document.querySelectorAll('.task-option').forEach(el => {
            el.classList.remove('border-primary', 'bg-light');
            el.querySelector('.select-task-btn').textContent = '选择';
            el.querySelector('.select-task-btn').className = 'btn btn-outline-primary btn-sm select-task-btn';
        });
        
        // 高亮当前选择
        taskElement.classList.add('border-primary', 'bg-light');
        const selectBtn = taskElement.querySelector('.select-task-btn');
        selectBtn.textContent = '已选择';
        selectBtn.className = 'btn btn-primary btn-sm select-task-btn';
        
        // 存储选择的任务
        selectedTaskForMigration = JSON.parse(taskElement.dataset.task);
        
        // 启用确认按钮
        document.getElementById('confirmMigrationBtn').disabled = false;
    }
    
    // 过滤任务列表
    function filterTasks() {
        const searchTerm = document.getElementById('taskSearchInput').value.toLowerCase().trim();
        filteredTasks = availableTasks.filter(task => 
            task.task_name.toLowerCase().includes(searchTerm) ||
            (task.task_id && task.task_id.toLowerCase().includes(searchTerm)) ||
            (task.top_categories && task.top_categories.some(cat => cat.toLowerCase().includes(searchTerm)))
        );
        renderTaskList();
        
        // 清除选择状态
        selectedTaskForMigration = null;
        document.getElementById('confirmMigrationBtn').disabled = true;
    }
    
    // 确认迁移
    function confirmMigration() {
        if (!selectedTaskForMigration || !window.currentMigrationArxivId) {
            showMigrationStatus('error', '请先选择一个任务');
            return;
        }
        
        const confirmBtn = document.getElementById('confirmMigrationBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> 迁移中...';
        confirmBtn.disabled = true;
        
        fetch('/api/migrate_paper_to_task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                arxiv_id: window.currentMigrationArxivId,
                target_task_name: selectedTaskForMigration.task_name,
                target_task_id: selectedTaskForMigration.task_id || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMigrationStatus('success', '论文迁移成功！页面将刷新...');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showMigrationStatus('error', data.error || '迁移失败');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('迁移请求失败:', error);
            showMigrationStatus('error', '网络错误，请稍后重试');
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
    }
    
    // 显示迁移状态
    function showMigrationStatus(type, message) {
        const statusDiv = document.getElementById('migrationStatus');
        const messageSpan = document.getElementById('migrationStatusMessage');
        
        statusDiv.className = 'alert mt-3';
        
        if (type === 'success') {
            statusDiv.classList.add('alert-success');
            messageSpan.innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;
        } else if (type === 'error') {
            statusDiv.classList.add('alert-danger');
            messageSpan.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${message}`;
        } else {
            statusDiv.classList.add('alert-info');
            messageSpan.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
        }
    }
    
    // 隐藏迁移状态
    function hideMigrationStatus() {
        const statusDiv = document.getElementById('migrationStatus');
        statusDiv.className = 'alert d-none mt-3';
    }
    
    // 工具函数：HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // 工具函数：格式化日期
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch {
            return dateString;
        }
    }

    // 页面加载完成后的处理
    document.addEventListener('DOMContentLoaded', function() {
        // 长文本自动展开/折叠功能
        const longTexts = document.querySelectorAll('.detail-content');
        longTexts.forEach(function(element) {
            if (element.textContent.length > 500) {
                element.style.maxHeight = '150px';
                element.style.overflow = 'hidden';
                element.style.position = 'relative';
                
                const expandBtn = document.createElement('button');
                expandBtn.className = 'btn btn-sm btn-link p-0 mt-2';
                expandBtn.innerHTML = '<i class="bi bi-chevron-down"></i> 显示更多';
                expandBtn.onclick = function() {
                    if (element.style.maxHeight === '150px') {
                        element.style.maxHeight = 'none';
                        this.innerHTML = '<i class="bi bi-chevron-up"></i> 显示较少';
                    } else {
                        element.style.maxHeight = '150px';
                        this.innerHTML = '<i class="bi bi-chevron-down"></i> 显示更多';
                    }
                };
                
                element.parentNode.appendChild(expandBtn);
            }
        });
    });
</script>
{% endblock %}