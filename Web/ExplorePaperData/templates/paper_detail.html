{% extends "base.html" %}

{% block title %}{{ paper.title }} - ArXiv论文详情{% endblock %}

{% block content %}
<!-- 返回按钮 -->
<div class="row mb-3">
    <div class="col">
        <a href="{{ url_for('papers') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回论文列表
        </a>
    </div>
</div>

<!-- 论文详情卡片 -->
<div class="paper-detail">
    <!-- 论文标题和基本信息 -->
    <div class="detail-section">
        <div class="row align-items-start">
            <div class="col-md-9">
                <h1 class="h3 mb-3">{{ paper.title }}</h1>
                
                <!-- 基本信息 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">ArXiv ID</div>
                        <div class="detail-content">
                            <code>{{ paper.arxiv_id }}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                    onclick="copyToClipboard('{{ paper.arxiv_id }}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">分类</div>
                        <div class="detail-content">
                            {% for category in paper.categories.split(',') %}
                            <span class="tag">{{ category | safe_strip }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">发布时间</div>
                        <div class="detail-content">{{ paper.published_date or '未知' }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">添加时间</div>
                        <div class="detail-content">{{ paper.created_at|format_date }}</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 text-end">
                <!-- 状态徽章 -->
                <span class="badge badge-{{ paper.processing_status|status_badge }} fs-6 mb-3">
                    {% if paper.processing_status == 'pending' %}
                        <i class="bi bi-clock"></i> 待处理
                    {% elif paper.processing_status == 'completed' %}
                        <i class="bi bi-check-circle"></i> 已完成
                    {% elif paper.processing_status == 'failed' %}
                        <i class="bi bi-x-circle"></i> 失败
                    {% endif %}
                </span>
                
                <!-- 操作按钮 -->
                <div class="d-grid gap-2">
                    {% if paper.pdf_url %}
                    <a href="{{ paper.pdf_url }}" target="_blank" class="btn btn-primary">
                        <i class="bi bi-file-pdf"></i> 查看PDF
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-info" onclick="copyToClipboard(window.location.href)">
                        <i class="bi bi-share"></i> 分享链接
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportPaperData()">
                        <i class="bi bi-download"></i> 导出数据
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 作者信息 -->
    {% if paper.authors %}
    <div class="detail-section">
        <div class="detail-label">作者</div>
        <div class="detail-content">{{ paper.authors }}</div>
    </div>
    {% endif %}
    
    <!-- 论文摘要 -->
    {% if paper.abstract %}
    <div class="detail-section">
        <div class="detail-label">摘要</div>
        <div class="detail-content">{{ paper.abstract }}</div>
    </div>
    {% endif %}
    
    <!-- 结构化分析 -->
    {% if paper.research_background or paper.research_objectives or paper.methods or paper.key_findings or paper.conclusions or paper.limitations or paper.future_work %}
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i>
                    结构化分析
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if paper.research_background %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究背景</div>
                        <div class="detail-content">{{ paper.research_background }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.research_objectives %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究目标</div>
                        <div class="detail-content">{{ paper.research_objectives }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.methods %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究方法</div>
                        <div class="detail-content">{{ paper.methods }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.key_findings %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">主要发现</div>
                        <div class="detail-content">{{ paper.key_findings }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.conclusions %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">结论</div>
                        <div class="detail-content">{{ paper.conclusions }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.limitations %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">局限性</div>
                        <div class="detail-content">{{ paper.limitations }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.future_work %}
                    <div class="col-md-12 mb-3">
                        <div class="detail-label">未来工作</div>
                        <div class="detail-content">{{ paper.future_work }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 关键词 -->
    {% if paper.keywords %}
    <div class="detail-section">
        <div class="detail-label">关键词</div>
        <div class="detail-content">
            {% for keyword in paper.keywords.split(',') %}
            <span class="tag">{{ keyword | safe_strip }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 标签 -->
    {% if paper.tags %}
    <div class="detail-section">
        <div class="detail-label">标签</div>
        <div class="detail-content">
            {% for tag in paper.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 元数据 -->
    {% if paper.metadata %}
    <div class="detail-section">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    元数据
                    <button class="btn btn-sm btn-outline-secondary float-end" 
                            type="button" data-bs-toggle="collapse" 
                            data-bs-target="#metadataCollapse">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h6>
            </div>
            <div class="collapse" id="metadataCollapse">
                <div class="card-body">
                    <pre class="bg-light p-3"><code>{{ paper.metadata|tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 时间信息 -->
    <div class="detail-section">
        <div class="row text-muted">
            <div class="col-md-6">
                <small>
                    <i class="bi bi-calendar-plus"></i>
                    创建时间: {{ paper.created_at|format_date }}
                </small>
            </div>
            <div class="col-md-6 text-md-end">
                <small>
                    <i class="bi bi-calendar-event"></i>
                    更新时间: {{ paper.updated_at|format_date }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- 相关操作 -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-link-45deg"></i>
                    相关操作
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('papers', category=(paper.categories.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-tag"></i>
                            查看同类论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('papers', q=(paper.authors.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-person"></i>
                            查看同作者论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        {% if paper.keywords %}
                        <a href="{{ url_for('papers', q=(paper.keywords.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-key"></i>
                            查看相关关键词
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                            <i class="bi bi-key"></i>
                            无关键词数据
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // 导出论文数据
    function exportPaperData() {
        const paperData = {
            arxiv_id: '{{ paper.arxiv_id }}',
            title: '{{ paper.title|e }}',
            authors: '{{ paper.authors|e }}',
            abstract: '{{ paper.abstract|e }}',
            categories: '{{ paper.categories }}',
            published_date: '{{ paper.published_date }}',
            pdf_url: '{{ paper.pdf_url }}',
            processing_status: '{{ paper.processing_status }}',
            research_background: '{{ paper.research_background|e }}',
            research_objectives: '{{ paper.research_objectives|e }}',
            methods: '{{ paper.methods|e }}',
            key_findings: '{{ paper.key_findings|e }}',
            conclusions: '{{ paper.conclusions|e }}',
            limitations: '{{ paper.limitations|e }}',
            future_work: '{{ paper.future_work|e }}',
            keywords: '{{ paper.keywords|e }}',
            tags: {{ paper.tags|tojson }},
            metadata: {{ paper.metadata|tojson }},
            created_at: '{{ paper.created_at }}',
            updated_at: '{{ paper.updated_at }}'
        };
        
        const dataStr = JSON.stringify(paperData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${paperData.arxiv_id}_data.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('论文数据已导出', 'success');
    }
    
    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // ESC 键返回列表
        if (e.key === 'Escape') {
            window.location.href = '{{ url_for("papers") }}';
        }
        
        // P 键打开PDF（如果有）
        if (e.key === 'p' || e.key === 'P') {
            {% if paper.pdf_url %}
            window.open('{{ paper.pdf_url }}', '_blank');
            {% endif %}
        }
    });
    
    // 页面加载完成后的处理
    document.addEventListener('DOMContentLoaded', function() {
        // 长文本自动展开/折叠功能
        const longTexts = document.querySelectorAll('.detail-content');
        longTexts.forEach(function(element) {
            if (element.textContent.length > 500) {
                element.style.maxHeight = '150px';
                element.style.overflow = 'hidden';
                element.style.position = 'relative';
                
                const expandBtn = document.createElement('button');
                expandBtn.className = 'btn btn-sm btn-link p-0 mt-2';
                expandBtn.innerHTML = '<i class="bi bi-chevron-down"></i> 显示更多';
                expandBtn.onclick = function() {
                    if (element.style.maxHeight === '150px') {
                        element.style.maxHeight = 'none';
                        this.innerHTML = '<i class="bi bi-chevron-up"></i> 显示较少';
                    } else {
                        element.style.maxHeight = '150px';
                        this.innerHTML = '<i class="bi bi-chevron-down"></i> 显示更多';
                    }
                };
                
                element.parentNode.appendChild(expandBtn);
            }
        });
    });
</script>
{% endblock %}