{% extends "base.html" %}

{% block title %}任务配置 - PaperGather{% endblock %}

{% block head %}
<style>
/* 配置页面专用样式 */
.config-section {
    background: white;
    border-radius: 12px;
    border-left: 4px solid var(--primary-color);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.config-section:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.config-section h4 {
    color: var(--primary-color);
    font-weight: 700;
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.config-section h4 i {
    font-size: 1.2rem;
    opacity: 0.8;
}

.form-help {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.375rem;
    line-height: 1.4;
}

.form-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
}

.form-control,
.form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    font-size: 0.95rem;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
}

.execution-mode-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid #e9ecef;
    border-radius: 12px;
    background: white;
    position: relative;
    overflow: hidden;
}

.execution-mode-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
}

.execution-mode-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 8px 24px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.execution-mode-card:hover::before {
    transform: translateX(0);
}

.execution-mode-card.selected {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, rgba(0,123,255,0.05) 0%, rgba(0,123,255,0.02) 100%);
    box-shadow: 0 8px 24px rgba(0,123,255,0.2);
}

.execution-mode-card.selected::before {
    transform: translateX(0);
}

.execution-mode-card .card-body {
    padding: 2rem 1.5rem;
}

.execution-mode-card i {
    transition: all 0.3s ease;
}

.execution-mode-card:hover i {
    transform: scale(1.1);
}

.execution-mode-card h5 {
    font-weight: 700;
    color: var(--dark-color);
    margin: 1rem 0 0.75rem;
}

.execution-mode-card p {
    color: var(--secondary-color);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

/* 中文搜索助手样式优化 */
.chinese-assistant-card {
    background: linear-gradient(135deg, rgba(40,167,69,0.05) 0%, rgba(40,167,69,0.02) 100%);
    border: 2px solid rgba(40,167,69,0.2);
    border-radius: 12px;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}

.chinese-assistant-card:hover {
    border-color: var(--success-color);
    box-shadow: 0 6px 20px rgba(40,167,69,0.15);
}

.chinese-assistant-card .card-title {
    color: var(--success-color);
    font-weight: 700;
    font-size: 1.1rem;
}

.chinese-assistant-card .card-text {
    color: #495057;
    line-height: 1.6;
}

/* 搜索能力说明卡片优化 */
.capability-card {
    background: linear-gradient(135deg, rgba(23,162,184,0.05) 0%, rgba(23,162,184,0.02) 100%);
    border: 2px solid rgba(23,162,184,0.2);
    border-radius: 12px;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}

.capability-card:hover {
    border-color: var(--info-color);
    box-shadow: 0 6px 20px rgba(23,162,184,0.15);
}

.capability-card .card-title {
    color: var(--info-color);
    font-weight: 700;
    font-size: 1.1rem;
}

.capability-row {
    margin-top: 1rem;
}

.capability-item {
    padding: 0.75rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.capability-item:hover {
    background-color: rgba(255,255,255,0.8);
    transform: translateY(-2px);
}

/* 按钮组优化 */
.btn-group .btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s ease;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* 执行操作区域优化 */
.execution-area {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.execution-area:hover {
    border-color: var(--primary-color);
    box-shadow: 0 6px 20px rgba(0,123,255,0.15);
}

.execution-area h5 {
    color: var(--primary-color);
    font-weight: 700;
    margin-bottom: 0.5rem;
}

/* 主要操作按钮优化 */
.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    border: none;
    border-radius: 8px;
    padding: 0.875rem 2rem;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,123,255,0.4);
    background: linear-gradient(135deg, #0056b3 0%, var(--primary-color) 100%);
}

/* 次要操作按钮优化 */
.btn-outline-secondary,
.btn-outline-info {
    border-radius: 8px;
    padding: 0.875rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover,
.btn-outline-info:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* 转换状态和结果样式优化 */
.translation-status {
    background: linear-gradient(135deg, rgba(40,167,69,0.1) 0%, rgba(40,167,69,0.05) 100%);
    border: 1px solid rgba(40,167,69,0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.translation-result .alert {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(40,167,69,0.15);
}

/* 定时间隔设置卡片优化 */
.interval-settings-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.interval-settings-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(0,123,255,0.1);
}

/* 模态框样式优化 */
.modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    border-bottom: none;
    padding: 1.5rem;
}

.modal-title {
    font-weight: 700;
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1.5rem 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
            <div class="page-header">
                <h1 class="display-6 fw-bold text-primary mb-2">
                    <i class="fas fa-cog me-3"></i>任务配置中心
                </h1>
                <p class="lead text-muted mb-0">智能配置论文收集任务，支持即时执行和定时执行模式</p>
                <div class="mt-2">
                    <span class="badge bg-primary-subtle text-primary me-2">
                        <i class="fas fa-robot me-1"></i>AI 智能转换
                    </span>
                    <span class="badge bg-success-subtle text-success me-2">
                        <i class="fas fa-clock me-1"></i>定时任务
                    </span>
                    <span class="badge bg-info-subtle text-info">
                        <i class="fas fa-expand-arrows-alt me-1"></i>大规模搜索
                    </span>
                </div>
            </div>
            <div class="config-actions">
                <div class="btn-group flex-wrap" role="group">
                    <button type="button" class="btn btn-outline-primary btn-lg" id="loadHistoryTaskBtn">
                        <i class="fas fa-history me-2"></i>历史任务
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 历史任务模态框 -->
<div class="modal fade" id="historyTaskModal" tabindex="-1" aria-labelledby="historyTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyTaskModalLabel">
                    <i class="fas fa-history me-2"></i>历史任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="historyStatusFilter">
                            <option value="">所有状态</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="stopped">已停止</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="historySearchInput" placeholder="搜索任务...">
                            <button class="btn btn-outline-secondary" type="button" id="refreshHistoryBtn">
                                <i class="fas fa-refresh"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="historyTaskList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<form id="taskConfigForm">
    <!-- 执行模式选择 -->
    <div class="config-section">
        <h4><i class="fas fa-play-circle me-2"></i>执行模式</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card execution-mode-card" data-mode="immediate">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-3x text-primary mb-3"></i>
                        <h5>即时执行</h5>
                        <p class="text-muted">
                            立即执行任务并返回结果<br>
                            适合一次性的论文搜索需求
                        </p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="execution_mode" 
                                   id="mode_immediate" value="immediate" checked>
                            <label class="form-check-label" for="mode_immediate">
                                选择此模式
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card execution-mode-card" data-mode="scheduled">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-3x text-success mb-3"></i>
                        <h5>定时执行</h5>
                        <p class="text-muted">
                            后台定时执行任务<br>
                            适合持续监控最新论文
                        </p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="execution_mode" 
                                   id="mode_scheduled" value="scheduled">
                            <label class="form-check-label" for="mode_scheduled">
                                选择此模式
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 定时间隔设置 -->
        <div id="scheduled_options" class="mt-4" style="display: none;">
            <div class="card interval-settings-card">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-stopwatch me-2"></i>定时执行间隔配置
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <label for="interval_seconds" class="form-label">
                                <i class="fas fa-clock me-2 text-primary"></i>执行间隔（秒）
                            </label>
                            <input type="number" class="form-control" id="interval_seconds" 
                                   name="interval_seconds" value="3600" min="300" max="86400"
                                   placeholder="输入间隔秒数">
                            <div class="form-help">
                                <i class="fas fa-info-circle me-1"></i>建议设置不少于 5 分钟（300秒）的执行间隔
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label">
                                <i class="fas fa-magic me-2 text-success"></i>快速设置
                            </label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setInterval(1800)">
                                    <i class="fas fa-clock me-1"></i>30分钟
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setInterval(3600)">
                                    <i class="fas fa-clock me-1"></i>1小时
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setInterval(21600)">
                                    <i class="fas fa-clock me-1"></i>6小时
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setInterval(86400)">
                                    <i class="fas fa-clock me-1"></i>24小时
                                </button>
                            </div>
                            <div class="form-help mt-2">
                                <i class="fas fa-lightbulb me-1"></i>点击按钮快速设置常用时间间隔
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索配置 -->
    <div class="config-section">
        <h4><i class="fas fa-search me-2"></i>搜索配置</h4>
        
        <!-- 中文搜索助手 -->
        <div class="card chinese-assistant-card mb-4">
            <div class="card-body">
                <h6 class="card-title d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fas fa-language fa-lg text-success"></i>
                    </div>
                    <div>
                        <span class="fw-bold">AI 智能搜索助手</span>
                        <div class="small text-muted mt-1">中文需求 → 专业英文搜索参数</div>
                    </div>
                </h6>
                <p class="card-text text-muted mb-4 lh-base">
                    <i class="fas fa-magic me-2 text-success"></i>
                    输入中文描述，AI 自动生成专业的英文搜索关键词和需求描述，让您的论文搜索更加精准高效
                </p>
                
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="chinese_search_input" class="form-label">中文研究需求</label>
                        <textarea class="form-control" id="chinese_search_input" rows="3" 
                                  placeholder="例如：我想找关于深度学习在医疗图像分析中应用的最新论文，特别是在CT扫描和MRI图像处理方面的研究"></textarea>
                        <div class="form-help">用中文描述您的研究兴趣和需求</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="chinese_assistant_model" class="form-label">转换模型</label>
                        <select class="form-select" id="chinese_assistant_model">
                            {% for model in available_models %}
                            <option value="{{ model }}" {% if model == default_config.llm_model_name %}selected{% endif %}>
                                {{ model }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-help">选择用于转换的LLM模型</div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-success" id="translateSearchBtn">
                        <i class="fas fa-magic me-1"></i>智能转换
                    </button>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>转换结果将自动填入下方的搜索关键词和需求描述字段
                    </small>
                </div>
                
                <!-- 转换状态和结果显示 -->
                <div id="translation_status" class="mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status">
                            <span class="visually-hidden">转换中...</span>
                        </div>
                        <span class="text-success">正在转换中，请稍候...</span>
                    </div>
                </div>
                
                <div id="translation_result" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="fas fa-check-circle me-1"></i>转换成功
                            <span id="confidence_badge" class="badge bg-success ms-2"></span>
                        </h6>
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <strong>搜索关键词:</strong>
                                <div id="result_keywords" class="text-muted small"></div>
                            </div>
                            <div class="col-md-4">
                                <strong>建议任务名称:</strong>
                                <div id="result_task_name" class="text-muted small"></div>
                            </div>
                            <div class="col-md-4">
                                <strong>转换质量:</strong>
                                <div id="result_confidence" class="text-muted small"></div>
                            </div>
                        </div>
                        <div id="translation_notes" class="small mb-0"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="search_query" class="form-label">搜索关键词 *</label>
                <input type="text" class="form-control" id="search_query" name="search_query" 
                       value="{{ default_config.search_query }}" required>
                <div class="form-help">用于在ArXiv中搜索论文的关键词</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="max_papers_per_search" class="form-label">每次搜索最大论文数</label>
                <input type="number" class="form-control" id="max_papers_per_search" 
                       name="max_papers_per_search" value="{{ default_config.max_papers_per_search }}" 
                       min="1" max="30000">
                <div class="form-help">小规模：1-100篇（快速），中规模：100-1000篇（平衡），大规模：1000-30000篇（全面覆盖，自动分页）</div>
            </div>
        </div>
        <div class="mb-3">
            <label for="user_requirements" class="form-label">用户需求描述 *</label>
            <textarea class="form-control" id="user_requirements" name="user_requirements" 
                      rows="3" required>{{ default_config.user_requirements }}</textarea>
            <div class="form-help">详细描述您的研究需求，LLM将根据此描述评估论文相关性</div>
        </div>
        
        <!-- 用户分析提示词（可选） -->
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enable_user_prompt" name="enable_user_prompt"
                       {% if default_config.enable_user_prompt %}checked{% endif %}>
                <label class="form-check-label" for="enable_user_prompt">
                    <i class="fas fa-lightbulb me-1 text-warning"></i>启用自定义分析提示词
                </label>
            </div>
            <div class="form-help">启用后可以指定论文分析时需要特别关注的方面，引导AI更精准地分析您关心的内容</div>
        </div>

        <div id="user_prompt_section" class="mb-3" style="display: none;">
            <label for="user_prompt" class="form-label">
                <i class="fas fa-pencil-alt me-1"></i>分析提示词
            </label>
            <textarea class="form-control" id="user_prompt" name="user_prompt" rows="4" 
                      placeholder="例如：请特别关注以下方面：&#10;1. 数据集的构建方法和质量评估&#10;2. 模型架构的创新点和技术细节&#10;3. 实验设计的合理性和完整性&#10;4. 与现有方法的对比分析和性能提升&#10;5. 论文的局限性和未来工作方向">{{ default_config.user_prompt if default_config.user_prompt else '' }}</textarea>
            <div class="form-help">
                <i class="fas fa-info-circle me-1"></i>输入您希望AI在分析论文时特别关注的方面，这些提示将被明确标记为"用户特别关注的方面"
            </div>
        </div>
        
        <!-- 搜索模式配置 -->
        <div class="mb-3">
            <label for="search_mode" class="form-label">搜索模式</label>
            <select class="form-select" id="search_mode" name="search_mode">
                {% for mode in available_search_modes %}
                <option value="{{ mode.value }}" 
                        {% if mode.value == default_config.search_mode %}selected{% endif %}
                        data-description="{{ mode.description }}">
                    {{ mode.label }}
                </option>
                {% endfor %}
            </select>
            <div class="form-help" id="search_mode_help">{{ available_search_modes[0].description }}</div>
        </div>
        
        <!-- 日期范围搜索参数 -->
        <div id="date_range_options" class="row mb-3" style="display: none;">
            <div class="col-md-6">
                <label for="start_year" class="form-label">起始年份</label>
                <input type="number" class="form-control" id="start_year" name="start_year" 
                       min="1991" max="2024" value="2022">
                <div class="form-help">ArXiv论文起始年份（1991年开始）</div>
            </div>
            <div class="col-md-6">
                <label for="end_year" class="form-label">结束年份</label>
                <input type="number" class="form-control" id="end_year" name="end_year" 
                       min="1991" max="2024" value="2023">
                <div class="form-help">搜索的结束年份</div>
            </div>
        </div>
        
        <!-- 某年之后搜索参数 -->
        <div id="after_year_options" class="mb-3" style="display: none;">
            <div class="col-md-6">
                <label for="after_year" class="form-label">起始年份</label>
                <input type="number" class="form-control" id="after_year" name="after_year" 
                       min="1991" max="2024" value="2024">
                <div class="form-help">搜索此年份之后的论文</div>
            </div>
        </div>
        
        <!-- 大规模搜索能力说明 -->
        <div class="card capability-card mb-4">
            <div class="card-body">
                <h6 class="card-title d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fas fa-rocket fa-lg text-info"></i>
                    </div>
                    <div>
                        <span class="fw-bold">增强搜索引擎</span>
                        <div class="small text-muted mt-1">支持最高 30,000 篇论文的大规模收集</div>
                    </div>
                </h6>
                <p class="card-text text-muted mb-4 lh-base">
                    <i class="fas fa-database me-2 text-info"></i>
                    系统现已支持大规模论文收集，适用于全面的研究领域调研和深度文献分析任务
                </p>
                
                <div class="row capability-row g-3">
                    <div class="col-lg-4">
                        <div class="capability-item text-center">
                            <div class="mb-2">
                                <i class="fas fa-bolt fa-2x text-success"></i>
                            </div>
                            <h6 class="fw-bold text-success mb-2">精准搜索</h6>
                            <div class="small text-muted mb-2">1-100篇论文</div>
                            <div class="small text-secondary">快速响应，专注目标</div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="capability-item text-center">
                            <div class="mb-2">
                                <i class="fas fa-balance-scale fa-2x text-warning"></i>
                            </div>
                            <h6 class="fw-bold text-warning mb-2">平衡搜索</h6>
                            <div class="small text-muted mb-2">100-1000篇论文</div>
                            <div class="small text-secondary">覆盖度与效率并重</div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="capability-item text-center">
                            <div class="mb-2">
                                <i class="fas fa-expand-arrows-alt fa-2x text-info"></i>
                            </div>
                            <h6 class="fw-bold text-info mb-2">全面覆盖</h6>
                            <div class="small text-muted mb-2">1000-30000篇论文</div>
                            <div class="small text-secondary">智能分页，完整追踪</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        大规模搜索采用智能分页处理和实时进度跟踪技术，确保系统稳定性和搜索结果的完整性
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务信息 -->
    <div class="config-section">
        <h4><i class="fas fa-tag me-2"></i>任务信息</h4>
        <div class="row">
            <div class="col-md-8 mb-3">
                <label for="task_name" class="form-label">任务名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="task_name" name="task_name" 
                       required maxlength="100" placeholder="例如：AI医疗论文收集任务">
                <div class="form-help">为此任务设置一个有意义的名称，便于后续管理和追踪</div>
                <div class="invalid-feedback">
                    请输入任务名称（1-100个字符）
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">任务ID</label>
                <input type="text" class="form-control" readonly placeholder="系统自动生成">
                <div class="form-help">任务执行后系统自动生成唯一标识</div>
            </div>
        </div>
    </div>



    <!-- 操作按钮 -->
    <div class="row">
        <div class="col-12">
            <div class="execution-area">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-4">
                    <div class="execution-info">
                        <h5 class="mb-2 d-flex align-items-center">
                            <i class="fas fa-rocket me-3 text-primary"></i>
                            准备启动任务
                        </h5>
                        <p class="mb-0 text-muted lh-base">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            请仔细检查所有配置参数，确认无误后点击执行按钮启动任务
                        </p>
                        <div class="mt-3">
                            <span class="badge bg-info-subtle text-info me-2">
                                <i class="fas fa-shield-alt me-1"></i>配置验证
                            </span>
                            <span class="badge bg-warning-subtle text-warning me-2">
                                <i class="fas fa-history me-1"></i>一键重置
                            </span>
                            <span class="badge bg-success-subtle text-success">
                                <i class="fas fa-play me-1"></i>立即执行
                            </span>
                        </div>
                    </div>
                    <div class="execution-controls">
                        <div class="d-flex flex-column flex-sm-row gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>重置配置
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="validateConfig()">
                                <i class="fas fa-check-circle me-2"></i>验证配置
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="executeBtn">
                                <i class="fas fa-play me-2"></i>启动任务
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- 执行结果模态框 -->
<div class="modal fade" id="executionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务执行</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="executionResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="viewTaskBtn" style="display: none;">
                    查看任务状态
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑任务模态框 -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑历史任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <!-- 基本配置 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">基本配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="edit_task_name" class="form-label">任务名称</label>
                                <input type="text" class="form-control" id="edit_task_name" maxlength="100" placeholder="例如：AI医疗论文收集任务">
                                <div class="form-text">为此任务设置一个有意义的名称</div>
                            </div>
                            <div class="mb-3">
                                <label for="edit_search_query" class="form-label">搜索查询</label>
                                <input type="text" class="form-control" id="edit_search_query" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_user_requirements" class="form-label">用户需求</label>
                                <textarea class="form-control" id="edit_user_requirements" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_llm_model_name" class="form-label">LLM模型</label>
                                <select class="form-select" id="edit_llm_model_name">
                                    <option value="">选择模型...</option>
                                    <!-- 模型选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 高级配置 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">高级配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_max_papers_per_search" class="form-label">最大论文数</label>
                                        <input type="number" class="form-control" id="edit_max_papers_per_search" min="1" max="30000" value="20">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_search_mode" class="form-label">搜索模式</label>
                                        <select class="form-select" id="edit_search_mode">
                                            <option value="latest">最新论文</option>
                                            <option value="relevance">相关性排序</option>
                                            <option value="date_range">日期范围</option>
                                            <option value="after_year">指定年份之后</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 高级模型配置 -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_abstract_analysis_model" class="form-label">摘要分析模型</label>
                                        <select class="form-select" id="edit_abstract_analysis_model">
                                            <option value="">使用默认模型</option>
                                            <!-- 模型选项将通过JavaScript动态加载 -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_full_paper_analysis_model" class="form-label">完整论文分析模型</label>
                                        <select class="form-select" id="edit_full_paper_analysis_model">
                                            <option value="">使用默认模型</option>
                                            <!-- 模型选项将通过JavaScript动态加载 -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_deep_analysis_model" class="form-label">深度分析模型</label>
                                        <select class="form-select" id="edit_deep_analysis_model">
                                            <option value="">使用默认模型</option>
                                            <!-- 模型选项将通过JavaScript动态加载 -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_vision_model" class="form-label">视觉模型</label>
                                        <select class="form-select" id="edit_vision_model">
                                            <option value="">使用默认模型</option>
                                            <!-- 模型选项将通过JavaScript动态加载 -->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 日期范围配置 -->
                            <div id="edit_date_range_config" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_start_year" class="form-label">开始年份</label>
                                            <input type="number" class="form-control" id="edit_start_year" min="1991" max="2030">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_end_year" class="form-label">结束年份</label>
                                            <input type="number" class="form-control" id="edit_end_year" min="1991" max="2030">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 指定年份之后配置 -->
                            <div id="edit_after_year_config" style="display: none;">
                                <div class="mb-3">
                                    <label for="edit_after_year" class="form-label">年份之后</label>
                                    <input type="number" class="form-control" id="edit_after_year" min="1991" max="2030">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_relevance_threshold" class="form-label">
                                            相关性阈值 
                                            <span class="badge bg-secondary" id="edit_relevance_threshold_value">70%</span>
                                        </label>
                                        <input type="range" class="form-range" id="edit_relevance_threshold" min="0.1" max="1.0" step="0.1" value="0.7">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_deep_analysis_threshold" class="form-label">
                                            深度分析阈值 
                                            <span class="badge bg-secondary" id="edit_deep_analysis_threshold_value">80%</span>
                                        </label>
                                        <input type="range" class="form-range" id="edit_deep_analysis_threshold" min="0.1" max="1.0" step="0.1" value="0.8">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_ocr_char_limit_for_analysis" class="form-label">OCR字符限制</label>
                                        <input type="number" class="form-control" id="edit_ocr_char_limit_for_analysis" 
                                               min="1000" max="50000" step="1000" value="10000">
                                        <div class="form-text">用于LLM分析的最大OCR字符数</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="edit_enable_deep_analysis" checked>
                                        <label class="form-check-label" for="edit_enable_deep_analysis">
                                            启用深度分析
                                        </label>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditedTaskBtn" onclick="HistoryTaskManager.saveEditedTask()">
                    <i class="fas fa-save me-1"></i>保存更改
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 执行模式卡片点击事件
    $('.execution-mode-card').click(function() {
        const mode = $(this).data('mode');
        $('input[name="execution_mode"][value="' + mode + '"]').prop('checked', true);
        $('.execution-mode-card').removeClass('selected');
        $(this).addClass('selected');
        
        if (mode === 'scheduled') {
            $('#scheduled_options').show();
        } else {
            $('#scheduled_options').hide();
        }
    });

    // 初始化选中状态
    $('input[name="execution_mode"]:checked').closest('.execution-mode-card').addClass('selected');
    
    // 用户提示词开关控制
    $('#enable_user_prompt').change(function() {
        if ($(this).is(':checked')) {
            $('#user_prompt_section').slideDown();
        } else {
            $('#user_prompt_section').slideUp();
            $('#user_prompt').val(''); // 清空文本
        }
    });

    // 页面加载时检查用户提示词初始状态
    if ($('#enable_user_prompt').is(':checked')) {
        $('#user_prompt_section').show();
    }


    // 搜索模式选择变化
    $('#search_mode').change(function() {
        const selectedMode = $(this).val();
        updateSearchModeOptions(selectedMode);
        updateSearchModeHelp();
    });

    // 初始化搜索模式选项
    updateSearchModeOptions($('#search_mode').val());

    // 任务名称实时验证
    $('#task_name').on('input blur', function() {
        validateTaskName();
    });

    // 表单提交
    $('#taskConfigForm').submit(function(e) {
        e.preventDefault();
        
        // 执行表单验证
        if (validateForm()) {
            executeTask();
        }
    });
});

function setInterval(seconds) {
    $('#interval_seconds').val(seconds);
}

function updateSearchModeOptions(selectedMode) {
    // 隐藏所有选项
    $('#date_range_options').hide();
    $('#after_year_options').hide();
    
    // 根据选择的模式显示相应选项
    if (selectedMode === 'date_range') {
        $('#date_range_options').show();
    } else if (selectedMode === 'after_year') {
        $('#after_year_options').show();
    }
}

function updateSearchModeHelp() {
    const selectedOption = $('#search_mode option:selected');
    const description = selectedOption.data('description');
    $('#search_mode_help').text(description);
}

function resetForm() {
    if (confirm('确定要重置所有配置吗？')) {
        document.getElementById('taskConfigForm').reset();
        $('.execution-mode-card').removeClass('selected');
        $('input[name="execution_mode"]:checked').closest('.execution-mode-card').addClass('selected');
        
        // 重置搜索模式选项
        updateSearchModeOptions($('#search_mode').val());
        updateSearchModeHelp();
    }
}

// 验证任务名称
function validateTaskName() {
    const taskNameInput = $('#task_name');
    const taskName = taskNameInput.val().trim();
    
    // 清除之前的验证状态
    taskNameInput.removeClass('is-valid is-invalid');
    
    if (!taskName) {
        taskNameInput.addClass('is-invalid');
        return false;
    }
    
    if (taskName.length < 1 || taskName.length > 100) {
        taskNameInput.addClass('is-invalid');
        return false;
    }
    
    taskNameInput.addClass('is-valid');
    return true;
}

// 验证整个表单
function validateForm() {
    let isValid = true;
    
    // 验证任务名称
    if (!validateTaskName()) {
        isValid = false;
        
        // 显示错误提示
        PaperGather.Utils.showAlert('error', '请输入有效的任务名称（1-100个字符）');
        
        // 滚动到任务名称字段
        $('html, body').animate({
            scrollTop: $('#task_name').offset().top - 100
        }, 500);
        
        // 聚焦到任务名称字段
        $('#task_name').focus();
    }
    
    return isValid;
}

function validateConfig() {
    const formData = getFormData();
    
    $.ajax({
        url: '/config/validate',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                showAlert('配置验证通过！', 'success');
            } else {
                showAlert('配置验证失败: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('验证请求失败', 'danger');
        }
    });
}

async function executeTask() {
    // 再次验证表单（防止直接调用此函数绕过验证）
    if (!validateForm()) {
        return;
    }
    
    let formData = getFormData();
    const mode = $('input[name="execution_mode"]:checked').val();
    
    // 确保任务名称存在
    if (!formData.task_name || !formData.task_name.trim()) {
        PaperGather.Utils.showAlert('error', '任务名称不能为空');
        return;
    }
    
    $('#executeBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>获取系统设置...');
    
    try {
        // 获取系统设置中的模型配置
        const systemSettings = await window.SystemSettings.get();
        console.log('获取到的系统设置:', systemSettings);
        
        // 将系统设置中的模型配置合并到任务配置中
        if (systemSettings) {
            // LLM模型配置
            if (systemSettings.llm_model_name) {
                formData.llm_model_name = systemSettings.llm_model_name;
            }
            if (systemSettings.relevance_threshold !== undefined) {
                formData.relevance_threshold = systemSettings.relevance_threshold;
            }
            
            // 高级模型配置
            if (systemSettings.abstract_analysis_model) {
                formData.abstract_analysis_model = systemSettings.abstract_analysis_model;
            }
            if (systemSettings.full_paper_analysis_model) {
                formData.full_paper_analysis_model = systemSettings.full_paper_analysis_model;
            }
            if (systemSettings.deep_analysis_model) {
                formData.deep_analysis_model = systemSettings.deep_analysis_model;
            }
            if (systemSettings.vision_model) {
                formData.vision_model = systemSettings.vision_model;
            }
            
            // 深度分析配置
            if (systemSettings.enable_deep_analysis !== undefined) {
                formData.enable_deep_analysis = systemSettings.enable_deep_analysis;
            }
            if (systemSettings.deep_analysis_threshold !== undefined) {
                formData.deep_analysis_threshold = systemSettings.deep_analysis_threshold;
            }
            if (systemSettings.ocr_char_limit_for_analysis !== undefined) {
                formData.ocr_char_limit_for_analysis = systemSettings.ocr_char_limit_for_analysis;
            }
            if (systemSettings.analysis_timeout !== undefined) {
                formData.analysis_timeout = systemSettings.analysis_timeout;
            }
            
            // 视频分析配置
            if (systemSettings.enable_video_analysis !== undefined) {
                formData.enable_video_analysis = systemSettings.enable_video_analysis;
            }
            if (systemSettings.video_analysis_model) {
                formData.video_analysis_model = systemSettings.video_analysis_model;
            }
        }
        
        console.log('合并系统设置后的任务配置:', formData);
        
    } catch (error) {
        console.warn('获取系统设置失败，使用基础配置:', error);
    }
    
    $('#executeBtn').html('<i class="fas fa-spinner fa-spin me-1"></i>执行中...');
    
    $.ajax({
        url: '/task/execute',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            mode: mode,
            config: formData
        }),
        success: function(response) {
            if (response.success) {
                showExecutionResult(response, true);
            } else {
                showExecutionResult(response, false);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {error: '请求失败'};
            showExecutionResult(response, false);
        },
        complete: function() {
            $('#executeBtn').prop('disabled', false).html('<i class="fas fa-play me-1"></i>执行任务');
        }
    });
}

function getFormData() {
    const formData = {};
    const form = document.getElementById('taskConfigForm');
    const formDataObj = new FormData(form);
    
    for (let [key, value] of formDataObj.entries()) {
        if (key === 'enable_paper_summarization' || key === 'enable_translation' || key === 'enable_user_prompt') {
            formData[key] = true;
        } else if (key.includes('max_') || key.includes('interval_') || key.includes('_year')) {
            formData[key] = parseInt(value);
        } else {
            formData[key] = value;
        }
    }
    
    // 处理搜索模式相关参数 - 根据搜索模式决定哪些参数有效
    const searchMode = formData['search_mode'];
    if (searchMode !== 'date_range') {
        formData['start_year'] = null;
        formData['end_year'] = null;
    }
    if (searchMode !== 'after_year') {
        formData['after_year'] = null;
    }
    
    return formData;
}

function showExecutionResult(response, success) {
    let html = '';
    if (success) {
        html = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>任务执行成功</h6>
                <p class="mb-1">${response.message}</p>
                <small>任务ID: ${response.task_id}</small>
            </div>
        `;
        $('#viewTaskBtn').show().data('task-id', response.task_id);
    } else {
        html = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-circle me-2"></i>任务执行失败</h6>
                <p class="mb-0">${response.error}</p>
            </div>
        `;
        $('#viewTaskBtn').hide();
    }
    
    $('#executionResult').html(html);
    $('#executionModal').modal('show');
}

function showAlert(message, type) {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('main .container-fluid').prepend(alert);
}

// 查看任务状态按钮
$(document).on('click', '#viewTaskBtn', function() {
    const taskId = $(this).data('task-id');
    window.open('/task/status/' + taskId, '_blank');
});

// 编辑模态框事件处理
$('#edit_search_mode').change(function() {
    const mode = $(this).val();
    HistoryTaskManager.updateEditSearchModeFields(mode);
});

// 编辑表单阈值滑块事件
$('#edit_relevance_threshold').on('input', function() {
    const value = (parseFloat($(this).val()) * 100).toFixed(0);
    $('#edit_relevance_threshold_value').text(value + '%');
});

$('#edit_deep_analysis_threshold').on('input', function() {
    const value = (parseFloat($(this).val()) * 100).toFixed(0);
    $('#edit_deep_analysis_threshold_value').text(value + '%');
});

// 中文搜索助手功能
$('#translateSearchBtn').click(function() {
    const chineseInput = $('#chinese_search_input').val().trim();
    const modelName = $('#chinese_assistant_model').val();
    
    if (!chineseInput) {
        showAlert('请输入中文研究需求', 'warning');
        return;
    }
    
    // 显示加载状态
    $('#translation_status').show();
    $('#translation_result').hide();
    $('#translateSearchBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>转换中...');
    
    // 调用API
    $.ajax({
        url: '/api/search/translate',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            chinese_input: chineseInput,
            model_name: modelName
        }),
        success: function(response) {
            if (response.success) {
                // 填充转换结果到表单
                $('#search_query').val(response.data.search_keywords);
                $('#user_requirements').val(response.data.user_requirements);
                
                // 填充建议的任务名称
                if (response.data.suggested_task_name) {
                    $('#task_name').val(response.data.suggested_task_name);
                    // 触发验证
                    validateTaskName();
                }
                
                // 显示转换结果反馈
                displayTranslationResult(response.data);
                
                showAlert('中文搜索需求转换成功！已自动填入搜索关键词、需求描述和任务名称', 'success');
            } else {
                showAlert('转换失败: ' + response.error, 'danger');
                $('#translation_result').hide();
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {error: '请求失败'};
            showAlert('转换请求失败: ' + response.error, 'danger');
            $('#translation_result').hide();
        },
        complete: function() {
            $('#translation_status').hide();
            $('#translateSearchBtn').prop('disabled', false).html('<i class="fas fa-magic me-1"></i>智能转换');
        }
    });
});

function displayTranslationResult(data) {
    // 设置质量徽章
    const confidenceBadge = $('#confidence_badge');
    let badgeClass = 'bg-success';
    let confidenceText = '高质量';
    
    if (data.confidence === 'medium') {
        badgeClass = 'bg-warning';
        confidenceText = '中等质量';
    } else if (data.confidence === 'low') {
        badgeClass = 'bg-danger';
        confidenceText = '需要优化';
    }
    
    confidenceBadge.removeClass('bg-success bg-warning bg-danger').addClass(badgeClass).text(confidenceText);
    
    // 显示转换结果详情
    $('#result_keywords').text(data.search_keywords || '未生成');
    $('#result_task_name').text(data.suggested_task_name || '未生成');
    $('#result_confidence').text(confidenceText);
    
    // 设置说明文字
    let notesText = data.notes || '转换完成';
    if (data.model_used) {
        notesText += ` (使用模型: ${data.model_used})`;
    }
    if (data.suggested_task_name) {
        notesText += ' - 建议的任务名称已自动填入，您可以根据需要修改。';
    }
    $('#translation_notes').text(notesText);
    
    // 显示结果
    $('#translation_result').show();
}

// 当编辑模态框显示时，加载模型列表
$('#editTaskModal').on('show.bs.modal', function() {
    // 加载模型列表
    $.get('/api/models')
        .then(response => {
            if (response.success) {
                // 为所有模型选择框添加选项
                const modelSelects = [
                    '#edit_llm_model_name',
                    '#edit_abstract_analysis_model',
                    '#edit_full_paper_analysis_model',
                    '#edit_deep_analysis_model',
                    '#edit_vision_model'
                ];
                
                modelSelects.forEach(selectId => {
                    const modelSelect = $(selectId);
                    const defaultText = selectId === '#edit_llm_model_name' ? '选择模型...' : '使用默认模型';
                    modelSelect.empty().append(`<option value="">${defaultText}</option>`);
                    
                    response.data.forEach(model => {
                        modelSelect.append(`<option value="${model.id}">${model.name}</option>`);
                    });
                });
            }
        })
        .catch(error => {
            console.error('加载模型列表失败:', error);
        });
});
</script>

<!-- 引入配置页面专用的JavaScript -->
<script src="{{ url_for('static', filename='js/config.js') }}"></script>
{% endblock %}