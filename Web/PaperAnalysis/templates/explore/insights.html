{% extends "base.html" %}

{% block title %}研究洞察 - ArXiv论文数据探索{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="row mb-4">
    <div class="col">
        <h1 class="display-6 mb-2">
            <i class="bi bi-lightbulb-fill"></i>
            研究洞察
        </h1>
        <p class="text-muted">基于结构化分析的深度研究趋势和洞察</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-outline-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i>
            刷新数据
        </button>
    </div>
</div>

<!-- 关键词分析 -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud"></i>
                    热门关键词分析 (Top 30)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="keywordCloudChart"></canvas>
                </div>
                
                <!-- 关键词标签云 -->
                <div class="mt-3">
                    <h6>关键词标签云</h6>
                    <div class="keyword-cloud">
                        {% for keyword in insights.keywords[:30] %}
                        {% set size = (keyword.frequency / insights.keywords[0].frequency * 100) if insights.keywords else 0 %}
                        <span class="keyword-tag" 
                              style="font-size: {{ (size / 100 * 1.5 + 0.8)|round(1) }}rem; opacity: {{ (size / 100 * 0.5 + 0.5)|round(1) }};"
                              onclick="searchKeyword('{{ keyword.keywords }}')">
                            {{ keyword.keywords }}
                            <small>({{ keyword.frequency }})</small>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 关键词统计 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-key-fill"></i>
                    关键词统计
                </h5>
            </div>
            <div class="card-body">
                <!-- 统计卡片 -->
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="stats-number text-primary">{{ insights.keywords|length }}</div>
                        <div class="stats-label">总关键词数</div>
                    </div>
                    <div class="col-6">
                        <div class="stats-number text-success">{{ insights.keywords[0].frequency if insights.keywords else 0 }}</div>
                        <div class="stats-label">最高频次</div>
                    </div>
                </div>
                
                <!-- Top 10 关键词列表 -->
                <div class="keyword-list">
                    <h6>Top 10 关键词</h6>
                    {% for keyword in insights.keywords[:10] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="keyword-item" onclick="searchKeyword('{{ keyword.keywords }}')">
                            {{ keyword.keywords|truncate(20) }}
                        </span>
                        <span class="badge bg-primary">{{ keyword.frequency }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 研究方法趋势 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear-fill"></i>
                    研究方法趋势分析
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="methodTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h6>热门研究方法</h6>
                        <div class="method-list">
                            {% for method in insights.methods[:10] %}
                            <div class="method-item mb-2 p-2 border rounded">
                                <div class="fw-bold">{{ method.methods|truncate(50) }}</div>
                                <small class="text-muted">使用次数: {{ method.count }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 高质量论文推荐 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-star-fill"></i>
                    高质量论文推荐
                    <small class="text-muted">（基于结构化分析完整性排序）</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="5%">排名</th>
                                <th width="40%">论文标题</th>
                                <th width="25%">作者</th>
                                <th width="15%">完整性评分</th>
                                <th width="15%">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paper in insights.high_impact %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <a href="{{ url_for('explore.paper_detail', arxiv_id=paper.arxiv_id) }}" 
                                       class="text-decoration-none fw-bold">
                                        {{ paper.title|truncate(80) }}
                                    </a>
                                </td>
                                <td>
                                    <small class="text-muted">{{ paper.authors|truncate(50) }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 15px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: {{ (paper.completeness_score / 6 * 100)|int }}%">
                                                {{ paper.completeness_score }}/6
                                            </div>
                                        </div>
                                        <small>{{ "%.0f"|format(paper.completeness_score / 6 * 100) }}%</small>
                                    </div>
                                </td>
                                <td>
                                    <a href="{{ url_for('explore.paper_detail', arxiv_id=paper.arxiv_id) }}" 
                                       class="btn btn-sm btn-primary">
                                        查看详情
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 研究领域洞察 -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bullseye"></i>
                    研究热点发现
                </h5>
            </div>
            <div class="card-body">
                <div class="insight-item mb-3">
                    <h6 class="text-primary">🔥 最热门研究领域</h6>
                    <p>基于关键词频次分析，当前最受关注的研究领域包括：</p>
                    <ul>
                        {% for keyword in insights.keywords[:5] %}
                        <li><strong>{{ keyword.keywords }}</strong> ({{ keyword.frequency }} 篇论文)</li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="insight-item mb-3">
                    <h6 class="text-success">📈 新兴研究方向</h6>
                    <p>结构化分析显示，以下方法论正在获得更多关注：</p>
                    <ul>
                        {% for method in insights.methods[:3] %}
                        <li>{{ method.methods|truncate(100) }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i>
                    质量趋势分析
                </h5>
            </div>
            <div class="card-body">
                <div class="insight-item mb-3">
                    <h6 class="text-info">📊 结构化分析趋势</h6>
                    <p>论文质量持续提升，结构化信息越来越完整：</p>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stats-number text-primary">{{ insights.high_impact|length }}</div>
                            <div class="stats-label">高质量论文</div>
                        </div>
                        <div class="col-4">
                            {% set avg_score = (insights.high_impact|sum(attribute='completeness_score') / insights.high_impact|length) if insights.high_impact else 0 %}
                            <div class="stats-number text-success">{{ "%.1f"|format(avg_score) }}</div>
                            <div class="stats-label">平均完整性</div>
                        </div>
                        <div class="col-4">
                            <div class="stats-number text-warning">{{ (insights.high_impact|selectattr('completeness_score', '==', 6)|list|length) }}</div>
                            <div class="stats-label">完美论文</div>
                        </div>
                    </div>
                </div>
                
                <div class="insight-item">
                    <h6 class="text-warning">💡 改进建议</h6>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success"></i> 继续提升结构化分析覆盖率</li>
                        <li><i class="bi bi-check-circle text-success"></i> 重点关注高频关键词领域</li>
                        <li><i class="bi bi-check-circle text-success"></i> 加强新兴方法论的追踪</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据脚本 -->
<script type="application/json" id="keywordData">
{
    "labels": [
        {% for keyword in insights.keywords[:15] %}
        "{{ keyword.keywords|truncate(15) }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    "data": [
        {% for keyword in insights.keywords[:15] %}
        {{ keyword.frequency }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

<script type="application/json" id="methodData">
{
    "labels": [
        {% for method in insights.methods[:10] %}
        "{{ method.methods|truncate(20) }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    "data": [
        {% for method in insights.methods[:10] %}
        {{ method.count }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        createInsightCharts();
    });
    
    function createInsightCharts() {
        // 关键词柱状图
        const keywordCtx = document.getElementById('keywordCloudChart');
        if (keywordCtx) {
            const keywordData = JSON.parse(document.getElementById('keywordData').textContent);
            new Chart(keywordCtx, {
                type: 'bar',
                data: {
                    labels: keywordData.labels,
                    datasets: [{
                        label: '出现频次',
                        data: keywordData.data,
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // 研究方法图
        const methodCtx = document.getElementById('methodTrendChart');
        if (methodCtx) {
            const methodData = JSON.parse(document.getElementById('methodData').textContent);
            new Chart(methodCtx, {
                type: 'horizontalBar',
                data: {
                    labels: methodData.labels,
                    datasets: [{
                        label: '使用次数',
                        data: methodData.data,
                        backgroundColor: 'rgba(46, 204, 113, 0.8)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }
    
    // 搜索关键词
    function searchKeyword(keyword) {
        window.location.href = `{{ url_for('explore.papers') }}?q=${encodeURIComponent(keyword)}`;
    }
    
    // 关键词标签云样式
    document.addEventListener('DOMContentLoaded', function() {
        const keywordTags = document.querySelectorAll('.keyword-tag');
        keywordTags.forEach(tag => {
            tag.style.cursor = 'pointer';
            tag.style.margin = '3px';
            tag.style.padding = '2px 6px';
            tag.style.backgroundColor = '#e9ecef';
            tag.style.borderRadius = '12px';
            tag.style.display = 'inline-block';
            tag.style.transition = 'all 0.2s ease';
            
            tag.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#007bff';
                this.style.color = 'white';
                this.style.transform = 'scale(1.1)';
            });
            
            tag.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#e9ecef';
                this.style.color = 'inherit';
                this.style.transform = 'scale(1)';
            });
        });
        
        // 关键词列表项样式
        const keywordItems = document.querySelectorAll('.keyword-item');
        keywordItems.forEach(item => {
            item.style.cursor = 'pointer';
            item.addEventListener('click', function() {
                this.style.color = '#007bff';
            });
        });
    });
</script>

<style>
.keyword-cloud {
    line-height: 2;
}

.keyword-tag {
    transition: all 0.2s ease;
}

.keyword-item:hover {
    color: #007bff !important;
    text-decoration: underline;
}

.method-item:hover {
    background-color: #f8f9fa !important;
    border-color: #007bff !important;
}

.insight-item {
    border-left: 3px solid #dee2e6;
    padding-left: 1rem;
}
</style>
{% endblock %}