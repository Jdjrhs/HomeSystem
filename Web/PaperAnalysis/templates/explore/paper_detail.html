{% extends "base.html" %}

{% block title %}{{ paper.title }} - ArXiv论文详情{% endblock %}

{% block content %}
<!-- 导航按钮组 -->
<div class="row mb-3">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <!-- 左侧：返回按钮 -->
            <a href="{{ url_for('explore.papers') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回论文列表
            </a>
            
            <!-- 中间：论文导航按钮 -->
            <div class="btn-group" role="group" aria-label="论文导航">
                {% if navigation.previous %}
                <a href="{{ url_for('explore.paper_detail', arxiv_id=navigation.previous.arxiv_id) }}" 
                   class="btn btn-outline-primary" id="prev-paper-btn"
                   title="{{ navigation.previous.title | truncate_text(50) }}">
                    <i class="bi bi-chevron-left"></i> 上一篇
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled title="已是第一篇论文">
                    <i class="bi bi-chevron-left"></i> 上一篇
                </button>
                {% endif %}
                
                {% if navigation.next %}
                <a href="{{ url_for('explore.paper_detail', arxiv_id=navigation.next.arxiv_id) }}" 
                   class="btn btn-outline-primary" id="next-paper-btn"
                   title="{{ navigation.next.title | truncate_text(50) }}">
                    下一篇 <i class="bi bi-chevron-right"></i>
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled title="已是最后一篇论文">
                    下一篇 <i class="bi bi-chevron-right"></i>
                </button>
                {% endif %}
            </div>
            
            <!-- 右侧：快捷键提示 -->
            <small class="text-muted d-none d-md-block">
                <i class="bi bi-keyboard"></i> 
                使用 ← → 键导航
            </small>
        </div>
    </div>
</div>

<!-- 论文详情卡片 -->
<div class="paper-detail">
    <!-- 论文标题和基本信息 -->
    <div class="detail-section">
        <div class="row align-items-start">
            <div class="col-md-9">
                <h1 class="h2 mb-4 text-dark">{{ paper.title }}</h1>
                
                <!-- 基本信息重新设计 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="info-item mb-3">
                            <span class="info-label">
                                <i class="bi bi-file-text text-primary"></i> ArXiv ID
                            </span>
                            <div class="info-value">
                                <code class="text-primary fw-bold">{{ paper.arxiv_id }}</code>
                                <button class="btn btn-sm btn-outline-secondary ms-2" 
                                        onclick="copyToClipboard('{{ paper.arxiv_id }}')" title="复制ID">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-calendar3 text-primary"></i> 发布时间
                            </span>
                            <div class="info-value text-muted">{{ paper.published_date or '未知' }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="info-item mb-3">
                            <span class="info-label">
                                <i class="bi bi-tags text-primary"></i> 分类
                            </span>
                            <div class="info-value">
                                {% for category in paper.categories.split(',') %}
                                <span class="badge bg-light text-dark border me-1 mb-1">{{ category | safe_strip }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if paper.full_paper_relevance_score is not none %}
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-star text-warning"></i> 相关度评分
                            </span>
                            <div class="info-value">
                                <div class="relevance-score-display d-flex align-items-center mb-2">
                                    <div class="score-stars me-2">
                                        {{ paper.full_paper_relevance_score|relevance_score_stars|safe }}
                                    </div>
                                    <div class="score-badge">
                                        {% set score = paper.full_paper_relevance_score | float %}
                                        {% if score >= 0.8 %}
                                            <span class="badge bg-success">高相关 ({{ "%.2f" | format(score) }})</span>
                                        {% elif score >= 0.6 %}
                                            <span class="badge bg-warning text-dark">中相关 ({{ "%.2f" | format(score) }})</span>
                                        {% elif score >= 0.4 %}
                                            <span class="badge bg-info">一般 ({{ "%.2f" | format(score) }})</span>
                                        {% elif score >= 0.2 %}
                                            <span class="badge bg-secondary">低相关 ({{ "%.2f" | format(score) }})</span>
                                        {% else %}
                                            <span class="badge bg-danger">不相关 ({{ "%.2f" | format(score) }})</span>
                                        {% endif %}
                                    </div>
                                    {% if paper.full_paper_relevance_justification %}
                                    <button class="btn btn-sm btn-outline-info ms-2" 
                                            type="button"
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#relevanceJustification" 
                                            aria-expanded="false" 
                                            aria-controls="relevanceJustification"
                                            title="查看评分理由">
                                        <i class="bi bi-info-circle"></i> 评分详情
                                    </button>
                                    {% endif %}
                                </div>
                                <!-- 可折叠的评分理由 -->
                                {% if paper.full_paper_relevance_justification %}
                                <div class="collapse" id="relevanceJustification">
                                    <div class="relevance-justification-content mt-2">
                                        <div class="small text-muted mb-2">
                                            <i class="bi bi-chat-text"></i> 评分理由
                                        </div>
                                        <div class="markdown-content small border-start border-info ps-3">
                                            {{ paper.full_paper_relevance_justification|markdown|safe }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <!-- 操作按钮重新设计 -->
                <div class="action-buttons-container">
                    <!-- 主要操作 -->
                    <div class="primary-actions mb-3">
                        {% if paper.pdf_url %}
                        <a href="{{ paper.pdf_url }}" target="_blank" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-file-pdf"></i> 查看PDF
                        </a>
                        {% endif %}
                        
                        <!-- 深度分析操作 -->
                        <div id="deep-analysis-section">
                            {% if paper.get('deep_analysis_status') %}
                                {% if paper.deep_analysis_status == 'completed' %}
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('explore.paper_analysis_view', arxiv_id=paper.arxiv_id) }}" class="btn btn-success w-100" target="_blank">
                                        <i class="bi bi-lightbulb-fill"></i> 查看深度分析
                                        <span class="badge bg-light text-success ms-2">✓ 已完成</span>
                                    </a>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')"> 
                                        <i class="bi bi-arrow-counterclockwise"></i> 重置状态
                                    </button>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'processing' %}
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info w-100" disabled id="processing-btn-{{ paper.arxiv_id }}">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">分析中...</span>
                                        </div>
                                        深度分析进行中...
                                        <div class="progress-indicator mt-1">
                                            <small class="text-light">预计耗时: 15-30分钟</small>
                                        </div>
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-warning btn-sm" onclick="cancelAnalysis('{{ paper.arxiv_id }}')">
                                            <i class="bi bi-x-circle"></i> 取消分析
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                            <i class="bi bi-arrow-counterclockwise"></i> 强制重置
                                        </button>
                                    </div>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'failed' %}
                                <div class="d-grid gap-2">
                                    <div class="alert alert-danger mb-2" role="alert">
                                        <i class="bi bi-exclamation-triangle"></i> 分析失败
                                    </div>
                                    <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                        <i class="bi bi-arrow-repeat"></i> 重试深度分析
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> 重置状态
                                    </button>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'cancelled' %}
                                <div class="d-grid gap-2">
                                    <div class="alert alert-warning mb-2" role="alert">
                                        <i class="bi bi-info-circle"></i> 分析已取消
                                    </div>
                                    <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                        <i class="bi bi-lightbulb"></i> 重新开始分析
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> 重置状态
                                    </button>
                                </div>
                                
                                {% elif paper.deep_analysis_status == 'pending' %}
                                <div class="d-grid gap-2">
                                    <div class="alert alert-info mb-2" role="alert">
                                        <i class="bi bi-clock"></i> 待处理状态
                                    </div>
                                    <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-primary w-100 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                        <i class="bi bi-lightbulb"></i> 开始深度分析
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAnalysisStatus('{{ paper.arxiv_id }}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> 重置状态
                                    </button>
                                </div>
                                
                                {% else %}
                                <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 mb-2 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                    <i class="bi bi-lightbulb"></i> 开始深度分析
                                </button>
                                {% endif %}
                            {% else %}
                            <button id="deep-analysis-btn-{{ paper.arxiv_id }}" class="btn btn-outline-primary w-100 mb-2 start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                                <i class="bi bi-lightbulb"></i> 开始深度分析
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Dify 知识库操作 -->
                    <div class="knowledge-base-section mb-3">
                        <h6 class="text-muted small mb-2">
                            <i class="bi bi-cloud"></i> 知识库
                        </h6>
                        <div id="dify-upload-section">
                            {% if paper.dify_document_id %}
                            <div class="alert alert-success small mb-2 py-2">
                                <i class="bi bi-cloud-check"></i> 已上传到知识库
                            </div>
                            <div class="btn-group w-100 mb-2" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('{{ paper.arxiv_id }}')">
                                    <i class="bi bi-shield-check"></i> 验证
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removePaperFromDify('{{ paper.arxiv_id }}')">
                                    <i class="bi bi-trash"></i> 移除
                                </button>
                            </div>
                            {% else %}
                            <button class="btn btn-outline-success w-100 mb-2" onclick="uploadPaperToDify('{{ paper.arxiv_id }}')">
                                <i class="bi bi-cloud-upload"></i> 上传到知识库
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- 其他操作 -->
                    <div class="other-actions">
                        <h6 class="text-muted small mb-2">
                            <i class="bi bi-gear"></i> 其他操作
                        </h6>
                        <div class="btn-group w-100 mb-2" role="group">
                            <button class="btn btn-outline-warning btn-sm" onclick="openMigrationModal('{{ paper.arxiv_id }}', '{{ paper.title | e }}')">
                                <i class="bi bi-arrow-right-circle"></i> 迁移
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="copyToClipboard(window.location.href)">
                                <i class="bi bi-share"></i> 分享
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 作者信息 -->
    {% if paper.authors %}
    <div class="detail-section">
        <div class="detail-label">作者</div>
        <div class="detail-content">{{ paper.authors }}</div>
    </div>
    {% endif %}
    
    <!-- 论文摘要 -->
    {% if paper.abstract %}
    <div class="detail-section">
        <div class="detail-label">摘要</div>
        <div class="detail-content markdown-content">{{ paper.abstract|markdown|safe }}</div>
    </div>
    {% endif %}
    
    <!-- 深度分析预览 -->
    {% if paper.has_deep_analysis and paper.deep_analysis_preview %}
    <div class="detail-section">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i>
                    深度分析内容预览
                    <span class="badge bg-light text-success ms-2">AI 深度分析</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="detail-content markdown-content">
                    {{ paper.deep_analysis_preview|markdown|safe }}
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('explore.paper_analysis_view', arxiv_id=paper.arxiv_id) }}" 
                       class="btn btn-success">
                        <i class="bi bi-eye"></i> 查看完整深度分析
                    </a>
                    <a href="{{ url_for('api.api_download_analysis', arxiv_id=paper.arxiv_id) }}" 
                       class="btn btn-outline-success ms-2">
                        <i class="bi bi-download"></i> 下载分析结果
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    
    <!-- 结构化分析 -->
    {% if not paper.has_deep_analysis and (paper.research_background or paper.research_objectives or paper.methods or paper.key_findings or paper.conclusions or paper.limitations or paper.future_work) %}
    <div class="detail-section">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i>
                    结构化分析
                    <span class="badge bg-light text-info ms-2">数据库翻译</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle"></i>
                        以下内容来自数据库存储的翻译数据，质量可能有限。建议进行深度分析以获得更优质的内容。
                    </div>
                    <button id="deep-analysis-btn-alt-{{ paper.arxiv_id }}" class="btn btn-success btn-sm start-deep-analysis" data-arxiv-id="{{ paper.arxiv_id }}">
                        <i class="bi bi-lightbulb"></i> 立即深度分析
                    </button>
                </div>
                <div class="row">
                    {% if paper.research_background %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究背景</div>
                        <div class="detail-content markdown-content">{{ paper.research_background|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.research_objectives %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究目标</div>
                        <div class="detail-content markdown-content">{{ paper.research_objectives|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.methods %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">研究方法</div>
                        <div class="detail-content markdown-content">{{ paper.methods|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.key_findings %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">主要发现</div>
                        <div class="detail-content markdown-content">{{ paper.key_findings|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.conclusions %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">结论</div>
                        <div class="detail-content markdown-content">{{ paper.conclusions|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.limitations %}
                    <div class="col-md-6 mb-3">
                        <div class="detail-label">局限性</div>
                        <div class="detail-content markdown-content">{{ paper.limitations|markdown|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if paper.future_work %}
                    <div class="col-md-12 mb-3">
                        <div class="detail-label">未来工作</div>
                        <div class="detail-content markdown-content">{{ paper.future_work|markdown|safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 关键词 -->
    {% if paper.keywords %}
    <div class="detail-section">
        <div class="detail-label">关键词</div>
        <div class="detail-content">
            {% for keyword in paper.keywords.split(',') %}
            <span class="tag">{{ keyword | safe_strip }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 标签 -->
    {% if paper.tags %}
    <div class="detail-section">
        <div class="detail-label">标签</div>
        <div class="detail-content">
            {% for tag in paper.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    
</div>

<!-- 相关操作 -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-link-45deg"></i>
                    相关操作
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('explore.papers', category=(paper.categories.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-tag"></i>
                            查看同类论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('explore.papers', q=(paper.authors.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-person"></i>
                            查看同作者论文
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        {% if paper.keywords %}
                        <a href="{{ url_for('explore.papers', q=(paper.keywords.split(',')[0] | safe_strip)) }}" 
                           class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-key"></i>
                            查看相关关键词
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                            <i class="bi bi-key"></i>
                            无关键词数据
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- 自定义提示词模态框 -->
<div class="modal fade" id="customPromptModal" tabindex="-1" aria-labelledby="customPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="customPromptModalLabel">
                    <i class="bi bi-lightbulb"></i> 深度分析 - 自定义提示词
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 步骤指示器 -->
                <div class="mb-4">
                    <div class="d-flex align-items-center">
                        <div class="step-indicator active me-3" id="step1-indicator">
                            <span class="step-number">1</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="step-title" id="step1-title">选择分析选项</div>
                        </div>
                        <div class="step-indicator me-3" id="step2-indicator">
                            <span class="step-number">2</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="step-title text-muted" id="step2-title">自定义提示词</div>
                        </div>
                    </div>
                </div>

                <!-- 第一步：询问是否添加自定义提示词 -->
                <div id="step1-content">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="bi bi-question-circle text-primary" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="mb-3">是否需要添加自定义分析提示词？</h5>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>说明：</strong>自定义提示词可以让AI更关注论文的特定方面，比如特定技术方法、应用场景或研究角度。
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-lightning text-success mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title">标准分析</h6>
                                    <p class="card-text text-muted">使用默认的分析模板，快速开始深度分析</p>
                                    <button type="button" class="btn btn-success" onclick="startAnalysisWithoutPrompt()">
                                        <i class="bi bi-play-fill"></i> 立即开始
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-gear text-primary mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title">自定义分析</h6>
                                    <p class="card-text text-muted">添加特定提示词，让AI关注您感兴趣的方面</p>
                                    <button type="button" class="btn btn-primary" onclick="proceedToCustomPrompt()">
                                        <i class="bi bi-pencil"></i> 自定义提示
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第二步：输入自定义提示词 -->
                <div id="step2-content" style="display: none;">
                    <div class="mb-4">
                        <h6><i class="bi bi-pencil-square"></i> 请输入您的自定义提示词</h6>
                        <p class="text-muted">描述您希望AI在分析时特别关注的方面或角度</p>
                    </div>

                    <!-- 提示词输入区域 -->
                    <div class="mb-3">
                        <label for="customPromptInput" class="form-label">
                            自定义提示词 
                            <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="customPromptInput" rows="4" 
                                  placeholder="例如：请特别关注论文中的数据集构建方法和评估指标，分析其创新性和实用性..."
                                  maxlength="500"></textarea>
                        <div class="form-text d-flex justify-content-between">
                            <span>清晰描述您关注的重点，有助于获得更精准的分析结果</span>
                            <span id="promptCharCount" class="text-muted">0/500</span>
                        </div>
                    </div>

                    <!-- 提示词示例 -->
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <i class="bi bi-lightbulb-fill text-warning"></i> 示例提示词
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('method')">
                                    <i class="bi bi-gear"></i> 关注技术方法
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('application')">
                                    <i class="bi bi-rocket"></i> 关注应用场景
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('innovation')">
                                    <i class="bi bi-star"></i> 关注创新点
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                        onclick="usePromptTemplate('evaluation')">
                                    <i class="bi bi-graph-up"></i> 关注评估方法
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 返回和继续按钮 -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="backToStep1()">
                            <i class="bi bi-arrow-left"></i> 返回
                        </button>
                        <button type="button" class="btn btn-primary" id="startCustomAnalysisBtn" onclick="startAnalysisWithCustomPrompt()">
                            <i class="bi bi-play-fill"></i> 开始自定义分析
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务迁移模态框 -->
<div class="modal fade" id="migrationModal" tabindex="-1" aria-labelledby="migrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="migrationModalLabel">
                    <i class="bi bi-arrow-right-circle"></i> 迁移到已有任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>论文:</strong> <span id="migrationPaperTitle"></span>
                </div>
                
                <!-- 任务搜索 -->
                <div class="mb-3">
                    <label for="taskSearchInput" class="form-label">搜索任务</label>
                    <input type="text" class="form-control" id="taskSearchInput" 
                           placeholder="输入任务名称进行搜索..." 
                           onkeyup="filterTasks()">
                </div>
                
                <!-- 任务列表 -->
                <div id="taskListContainer" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载任务列表...</p>
                    </div>
                </div>
                
                <!-- 迁移状态显示 -->
                <div id="migrationStatus" class="alert d-none mt-3" role="alert">
                    <span id="migrationStatusMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="confirmMigrationBtn" onclick="confirmMigration()" disabled>
                    <i class="bi bi-check-circle"></i> 确认迁移
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
    .cursor-pointer {
        cursor: pointer;
    }
    
    .task-option {
        transition: all 0.2s ease;
    }
    
    .task-option:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .task-option.border-primary {
        border-width: 2px !important;
    }
    
    /* Toast 动画 */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* 禁用状态的深度分析按钮样式 */
    .start-deep-analysis:disabled,
    .start-deep-analysis.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .start-deep-analysis:disabled .bi-hourglass-split {
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 自定义提示词模态框样式 */
    .step-indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .step-indicator.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .step-indicator .step-number {
        color: #6c757d;
        font-weight: bold;
        font-size: 14px;
    }
    
    .step-indicator.active .step-number {
        color: white;
    }
    
    .step-title {
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .step-title.active {
        color: #0d6efd;
    }
    
    #customPromptModal .card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    #customPromptModal .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        border-color: var(--bs-primary);
    }
    
    #customPromptInput {
        resize: vertical;
        min-height: 100px;
    }
    
    #customPromptInput:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>

<script>
    // 深度分析功能JavaScript - 参考重新分析按钮的成功模式
    console.log('🚀 开始加载论文详情页面深度分析JavaScript');
    console.log('📍 当前页面URL:', window.location.href);
    console.log('📍 页面加载状态:', document.readyState);
    console.log('📍 当前时间:', new Date().toLocaleTimeString());
    
    // 全局函数：启动深度分析 - 新版本支持自定义提示词
    function startDeepAnalysis(arxivId) {
        console.log('🚀 启动深度分析函数被调用, ArXiv ID:', arxivId);
        
        if (!arxivId) {
            console.error('❌ 无法获取论文ID');
            alert('无法获取论文ID，请刷新页面重试');
            return;
        }
        
        // 存储当前ArXiv ID供模态框使用
        window.currentAnalysisArxivId = arxivId;
        
        // 重置模态框状态
        resetCustomPromptModal();
        
        // 显示自定义提示词模态框
        console.log('🎯 显示自定义提示词选择模态框');
        const modal = new bootstrap.Modal(document.getElementById('customPromptModal'));
        modal.show();
        
    }
    
    console.log('✅ startDeepAnalysis函数定义完成');
    console.log('🔍 startDeepAnalysis函数类型:', typeof startDeepAnalysis);
    
    // === 自定义提示词模态框相关函数 ===
    
    // 重置模态框状态
    function resetCustomPromptModal() {
        // 重置步骤指示器
        document.getElementById('step1-indicator').classList.add('active');
        document.getElementById('step2-indicator').classList.remove('active');
        document.getElementById('step1-title').classList.remove('text-muted');
        document.getElementById('step2-title').classList.add('text-muted');
        
        // 显示第一步，隐藏第二步
        document.getElementById('step1-content').style.display = 'block';
        document.getElementById('step2-content').style.display = 'none';
        
        // 清空提示词输入框
        document.getElementById('customPromptInput').value = '';
        updatePromptCharCount();
    }
    
    // 进入自定义提示词输入步骤
    function proceedToCustomPrompt() {
        // 更新步骤指示器
        document.getElementById('step1-indicator').classList.remove('active');
        document.getElementById('step2-indicator').classList.add('active');
        document.getElementById('step1-title').classList.add('text-muted');
        document.getElementById('step2-title').classList.remove('text-muted');
        document.getElementById('step2-title').classList.add('active');
        
        // 切换内容显示
        document.getElementById('step1-content').style.display = 'none';
        document.getElementById('step2-content').style.display = 'block';
        
        // 聚焦到输入框
        setTimeout(() => {
            document.getElementById('customPromptInput').focus();
        }, 300);
    }
    
    // 返回第一步
    function backToStep1() {
        // 更新步骤指示器
        document.getElementById('step1-indicator').classList.add('active');
        document.getElementById('step2-indicator').classList.remove('active');
        document.getElementById('step1-title').classList.remove('text-muted');
        document.getElementById('step2-title').classList.add('text-muted');
        document.getElementById('step2-title').classList.remove('active');
        
        // 切换内容显示
        document.getElementById('step1-content').style.display = 'block';
        document.getElementById('step2-content').style.display = 'none';
    }
    
    // 使用提示词模板
    function usePromptTemplate(templateType) {
        const templates = {
            'method': '请特别关注论文中的技术方法和算法实现，分析其创新性、复杂度和实用性。',
            'application': '请重点分析论文的应用场景和实际部署情况，评估其商业价值和实际应用潜力。',
            'innovation': '请着重分析论文的创新点和突破性贡献，对比现有技术的优势和局限性。',
            'evaluation': '请详细分析论文的实验设计、评估方法和性能指标，评估实验结果的可信度。'
        };
        
        const template = templates[templateType];
        if (template) {
            document.getElementById('customPromptInput').value = template;
            updatePromptCharCount();
        }
    }
    
    // 更新字符计数
    function updatePromptCharCount() {
        const input = document.getElementById('customPromptInput');
        const counter = document.getElementById('promptCharCount');
        if (input && counter) {
            const length = input.value.length;
            counter.textContent = `${length}/500`;
            
            // 根据字符数改变颜色
            if (length > 450) {
                counter.classList.add('text-warning');
                counter.classList.remove('text-muted');
            } else if (length >= 500) {
                counter.classList.add('text-danger');
                counter.classList.remove('text-warning', 'text-muted');
            } else {
                counter.classList.remove('text-warning', 'text-danger');
                counter.classList.add('text-muted');
            }
        }
    }
    
    // 不使用自定义提示词直接开始分析
    function startAnalysisWithoutPrompt() {
        console.log('🚀 用户选择标准分析模式');
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('customPromptModal'));
        if (modal) {
            modal.hide();
        }
        
        // 执行标准分析
        executeDeepAnalysis(window.currentAnalysisArxivId, false, null);
    }
    
    // 使用自定义提示词开始分析
    function startAnalysisWithCustomPrompt() {
        console.log('🚀 用户选择自定义分析模式');
        
        const customPrompt = document.getElementById('customPromptInput').value.trim();
        
        // 验证提示词
        if (!customPrompt) {
            alert('请输入自定义提示词后再继续');
            document.getElementById('customPromptInput').focus();
            return;
        }
        
        if (customPrompt.length < 10) {
            alert('提示词太短，请输入至少10个字符的详细描述');
            document.getElementById('customPromptInput').focus();
            return;
        }
        
        console.log('✅ 自定义提示词验证通过:', customPrompt);
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('customPromptModal'));
        if (modal) {
            modal.hide();
        }
        
        // 执行自定义分析
        executeDeepAnalysis(window.currentAnalysisArxivId, true, customPrompt);
    }
    
    // 执行深度分析的核心函数
    function executeDeepAnalysis(arxivId, enableUserPrompt, userPrompt) {
        console.log('🚀 开始执行深度分析');
        console.log('📄 ArXiv ID:', arxivId);
        console.log('🎯 启用用户提示词:', enableUserPrompt);
        console.log('📝 用户提示词:', userPrompt);
        
        if (!arxivId) {
            console.error('❌ 无法获取论文ID');
            alert('无法获取论文ID，请刷新页面重试');
            return;
        }
        
        // 禁用深度分析按钮
        const primaryBtn = document.getElementById('deep-analysis-btn-' + arxivId);
        const altBtn = document.getElementById('deep-analysis-btn-alt-' + arxivId);
        
        if (primaryBtn) {
            primaryBtn.disabled = true;
            primaryBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 分析中...';
            console.log('🔒 主要分析按钮已禁用');
        }
        if (altBtn) {
            altBtn.disabled = true;
            altBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 分析中...';
            console.log('🔒 备选分析按钮已禁用');
        }
        
        console.log('📤 准备调用深度分析API');
        
        // 构建请求参数
        const requestBody = {
            config: {
                enable_user_prompt: enableUserPrompt,
                user_prompt: userPrompt || ''
            }
        };
        
        // 获取系统配置并合并
        const configPromise = window.SystemSettings ? 
            window.SystemSettings.getAnalysisConfig().then(config => {
                console.log('✅ 成功获取系统配置:', config);
                // 合并系统配置和用户提示词配置
                requestBody.config = {...config, ...requestBody.config};
                return requestBody;
            }).catch(error => {
                console.warn('⚠️ 获取系统配置失败，使用基本配置:', error);
                return requestBody;
            }) :
            Promise.resolve(requestBody);
        
        const apiUrl = '/api/analysis/paper/' + arxivId + '/analyze';
        console.log('🚀 API请求URL:', apiUrl);
        
        configPromise
            .then(finalRequestBody => {
                console.log('📤 最终请求配置:', finalRequestBody);
                
                return fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(finalRequestBody)
                });
            })
            .then(response => {
                console.log('📨 收到API响应，状态码:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('📊 API响应数据:', data);
                
                if (data.success) {
                    console.log('✅ 深度分析启动成功');
                    const successMsg = enableUserPrompt ? 
                        '自定义深度分析已成功启动！AI将根据您的提示词进行专项分析，正在后台处理中...' :
                        '标准深度分析已成功启动！正在后台处理中，系统将自动监控进度...';
                    alert(successMsg);
                    
                    // 启动状态轮询
                    startDeepAnalysisPolling(arxivId);
                } else {
                    console.error('❌ 分析启动失败:', data.error);
                    alert('启动分析失败: ' + (data.error || '未知错误'));
                    
                    // 恢复按钮状态
                    restoreAnalysisButtons(arxivId);
                }
            })
            .catch(error => {
                console.error('💥 深度分析API调用失败:', error);
                alert('启动分析时发生错误: ' + error.message);
                
                // 恢复按钮状态
                restoreAnalysisButtons(arxivId);
            });
    }
    
    // 恢复分析按钮状态的辅助函数
    function restoreAnalysisButtons(arxivId) {
        const primaryBtn = document.getElementById('deep-analysis-btn-' + arxivId);
        const altBtn = document.getElementById('deep-analysis-btn-alt-' + arxivId);
        
        if (primaryBtn) {
            primaryBtn.disabled = false;
            primaryBtn.innerHTML = '<i class="bi bi-lightbulb"></i> 开始深度分析';
        }
        if (altBtn) {
            altBtn.disabled = false;
            altBtn.innerHTML = '<i class="bi bi-lightbulb"></i> 立即深度分析';
        }
    }
    
    // 智能获取ArXiv ID的函数
    function getArxivIdFromPage() {
        // 方法1: 从URL路径解析 (/explore/paper/ARXIV_ID)
        const urlPath = window.location.pathname;
        const pathMatch = urlPath.match(/\/explore\/paper\/([^\/]+)/);
        if (pathMatch && pathMatch[1]) {
            console.log('✅ 从URL路径获取到ArXiv ID:', pathMatch[1]);
            return pathMatch[1];
        }
        
        // 方法2: 从DOM元素获取（备选方案）
        const arxivIdElement = document.querySelector('[data-arxiv-id]');
        if (arxivIdElement) {
            const arxivId = arxivIdElement.getAttribute('data-arxiv-id');
            console.log('✅ 从DOM元素获取到ArXiv ID:', arxivId);
            return arxivId;
        }
        
        console.error('❌ 无法从URL或DOM中获取ArXiv ID');
        return null;
    }
    
    // DOMContentLoaded事件处理（完全参考重新分析按钮的模式）
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎯 DOMContentLoaded事件触发');
        
        // 使用智能方法获取ArXiv ID
        const arxivId = getArxivIdFromPage();
        console.log('📄 页面ArXiv ID:', arxivId);
        
        if (!arxivId) {
            console.error('❌ 无法获取ArXiv ID，深度分析功能将无法使用');
            return;
        }
        
        // 绑定主要深度分析按钮事件
        console.log('🔍 开始绑定主要深度分析按钮事件');
        const primaryBtn = document.getElementById('deep-analysis-btn-' + arxivId);
        console.log('🔍 找到主要分析按钮:', primaryBtn);
        
        if (primaryBtn) {
            console.log('✅ 主要分析按钮存在，开始绑定事件');
            primaryBtn.addEventListener('click', function(e) {
                console.log('🔥 主要深度分析按钮被点击!');
                e.preventDefault();
                
                const buttonArxivId = this.getAttribute('data-arxiv-id');
                console.log('📄 获取到按钮ArXiv ID:', buttonArxivId);
                console.log('🔍 startDeepAnalysis函数类型:', typeof startDeepAnalysis);
                
                if (buttonArxivId && typeof startDeepAnalysis === 'function') {
                    console.log('✅ 开始调用startDeepAnalysis函数');
                    startDeepAnalysis(buttonArxivId);
                } else {
                    console.error('❌ startDeepAnalysis函数不可用或ArXiv ID缺失');
                    console.error('   ArXiv ID:', buttonArxivId);
                    console.error('   函数类型:', typeof startDeepAnalysis);
                }
            });
            console.log('✅ 主要深度分析按钮事件绑定完成');
        } else {
            console.log('ℹ️ 主要深度分析按钮未找到（可能处于不同状态）');
        }
        
        // 绑定备选深度分析按钮事件
        console.log('🔍 开始绑定备选深度分析按钮事件');
        const altBtn = document.getElementById('deep-analysis-btn-alt-' + arxivId);
        console.log('🔍 找到备选分析按钮:', altBtn);
        
        if (altBtn) {
            console.log('✅ 备选分析按钮存在，开始绑定事件');
            altBtn.addEventListener('click', function(e) {
                console.log('🔥 备选深度分析按钮被点击!');
                e.preventDefault();
                
                const buttonArxivId = this.getAttribute('data-arxiv-id');
                console.log('📄 获取到按钮ArXiv ID:', buttonArxivId);
                
                if (buttonArxivId && typeof startDeepAnalysis === 'function') {
                    console.log('✅ 开始调用startDeepAnalysis函数');
                    startDeepAnalysis(buttonArxivId);
                } else {
                    console.error('❌ startDeepAnalysis函数不可用或ArXiv ID缺失');
                }
            });
            console.log('✅ 备选深度分析按钮事件绑定完成');
        } else {
            console.log('ℹ️ 备选深度分析按钮未找到');
        }
        
        console.log('🎯 深度分析按钮事件绑定完成');
    });
    
    // Global function: Cancel Deep Analysis  
    function cancelAnalysis(arxivId) {
        console.log('🔥 cancelAnalysis被调用! arxivId:', arxivId);
        
        if (!confirm('确定要取消深度分析吗？\n\n正在进行的分析任务将被终止。')) {
            return;
        }
        
        const analysisSection = document.getElementById('deep-analysis-section');
        const originalContent = analysisSection.innerHTML;
        
        // 显示取消中状态
        analysisSection.innerHTML = `
            <div class="d-grid gap-2">
                <button class="btn btn-warning w-100" disabled>
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">取消中...</span>
                    </div>
                    正在取消分析...
                </button>
            </div>
        `;
        
        // 发送取消请求
        fetch('/api/analysis/paper/' + arxivId + '/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('分析任务已成功取消！', 'success');
                // 刷新页面以显示更新状态
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert('取消分析失败: ' + data.error, 'error');
                // 恢复原始状态
                analysisSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('取消分析失败:', error);
            showAlert('取消分析时发生网络错误', 'error');
            // 恢复原始状态
            analysisSection.innerHTML = originalContent;
        });
    }
    
    // Global function: Reset Analysis Status
    function resetAnalysisStatus(arxivId) {
        console.log('🔄 resetAnalysisStatus被调用! arxivId:', arxivId);
        
        if (!confirm('确定要重置该论文的分析状态吗？\n\n这将清除所有相关的分析记录和状态。')) {
            return;
        }
        
        const analysisSection = document.getElementById('deep-analysis-section');
        const originalContent = analysisSection.innerHTML;
        
        // 显示重置中状态
        analysisSection.innerHTML = `
            <div class="d-grid gap-2">
                <button class="btn btn-secondary w-100" disabled>
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">重置中...</span>
                    </div>
                    正在重置状态...
                </button>
            </div>
        `;
        
        // 发送重置请求
        fetch('/api/analysis/paper/' + arxivId + '/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('分析状态已成功重置！', 'success');
                // 刷新页面以显示更新状态
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert('重置状态失败: ' + data.error, 'error');
                // 恢复原始状态
                analysisSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('重置状态失败:', error);
            showAlert('重置状态时发生网络错误', 'error');
            // 恢复原始状态
            analysisSection.innerHTML = originalContent;
        });
    }
    
    // 全局函数：深度分析状态轮询
    function startDeepAnalysisPolling(arxivId) {
        console.log('🔄 开始深度分析状态轮询:', arxivId);
        
        const pollInterval = setInterval(() => {
            console.log('📡 轮询分析状态:', arxivId);
            
            fetch(`/api/analysis/paper/${arxivId}/status`)
            .then(response => response.json())
            .then(data => {
                console.log('📊 分析状态轮询结果:', data);
                
                if (data.success) {
                    const status = data.status;
                    console.log('📋 当前分析状态:', status);
                    
                    if (status === 'completed') {
                        clearInterval(pollInterval);
                        console.log('✅ 深度分析完成！准备刷新页面');
                        showAlert('深度分析完成！页面将自动刷新显示结果...', 'success', 3000);
                        
                        // 3秒后刷新页面以显示分析结果
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                        
                    } else if (status === 'failed') {
                        clearInterval(pollInterval);
                        console.error('❌ 深度分析失败');
                        showAlert('深度分析失败，请查看错误信息或重试', 'error', 5000);
                        
                        // 恢复深度分析按钮状态
                        enableDeepAnalysisButtons(arxivId);
                        
                    } else if (status === 'cancelled') {
                        clearInterval(pollInterval);
                        console.log('⚠️ 深度分析已被取消');
                        showAlert('深度分析已被取消', 'warning', 3000);
                        
                        // 刷新页面以显示更新状态
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                        
                    } else if (status === 'processing') {
                        // 继续轮询
                        console.log('⏳ 深度分析仍在进行中...');
                    } else {
                        console.log('📝 分析状态:', status);
                    }
                } else {
                    console.error('❌ 获取分析状态失败:', data.error);
                    // 不停止轮询，继续尝试
                }
            })
            .catch(error => {
                console.error('💥 状态轮询网络错误:', error);
                // 不停止轮询，继续尝试
            });
        }, 5000); // 每5秒轮询一次
        
        // 15分钟后停止轮询（避免无限轮询）
        setTimeout(() => {
            clearInterval(pollInterval);
            console.log('⏰ 深度分析轮询超时，停止轮询');
            showAlert('深度分析监控超时，请手动刷新页面查看结果', 'warning', 5000);
            
            // 恢复深度分析按钮状态
            enableDeepAnalysisButtons(arxivId);
        }, 15 * 60 * 1000); // 15分钟超时
    }
    
    // Make functions globally accessible
    window.startDeepAnalysis = startDeepAnalysis;
    window.cancelAnalysis = cancelAnalysis;
    window.resetAnalysisStatus = resetAnalysisStatus;
    window.startDeepAnalysisPolling = startDeepAnalysisPolling;
    window.getArxivIdFromPage = getArxivIdFromPage;
    
    console.log('✅ Deep analysis functions registered globally');
    console.log('startDeepAnalysis 类型:', typeof window.startDeepAnalysis);
    console.log('cancelDeepAnalysis 类型:', typeof window.cancelDeepAnalysis);
    console.log('getArxivIdFromPage 类型:', typeof window.getArxivIdFromPage);
    
    // Helper functions for button state management
    function restoreAnalysisButton(arxivId, analysisSection) {
        console.log('🔄 恢复深度分析按钮状态:', arxivId);
        enableDeepAnalysisButtons(arxivId);
        analysisSection.innerHTML = `
            <button class="btn btn-outline-primary w-100 start-deep-analysis" data-arxiv-id="${arxivId}">
                <i class="bi bi-lightbulb"></i> 开始深度分析
            </button>
        `;
    }
    
    function disableDeepAnalysisButtons(arxivId) {
        console.log('🔒 禁用深度分析按钮:', arxivId);
        const buttons = document.querySelectorAll('.start-deep-analysis[data-arxiv-id="' + arxivId + '"]');
        buttons.forEach(button => {
            button.disabled = true;
            button.classList.add('disabled');
            // 添加视觉指示
            const originalText = button.innerHTML;
            button.setAttribute('data-original-text', originalText);
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> 分析中...';
        });
    }
    
    function enableDeepAnalysisButtons(arxivId) {
        console.log('🔓 启用深度分析按钮:', arxivId);
        const buttons = document.querySelectorAll('.start-deep-analysis[data-arxiv-id="' + arxivId + '"]');
        buttons.forEach(button => {
            button.disabled = false;
            button.classList.remove('disabled');
            // 恢复原始文本
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
                button.removeAttribute('data-original-text');
            }
        });
    }
    
    // 页面加载时检查分析状态并相应地禁用按钮
    function checkAndDisableIfProcessing() {
        console.log('🔍 检查页面加载时的分析状态...');
        
        // 从页面元素判断当前分析状态
        const analysisSection = document.getElementById('deep-analysis-section');
        if (analysisSection) {
            // 检查是否有分析中的指示器
            const spinnerButton = analysisSection.querySelector('.spinner-border');
            const disabledButtons = analysisSection.querySelectorAll('button[disabled]');
            
            // 检查按钮文本是否包含"分析进行中"或类似内容
            let isProcessing = false;
            disabledButtons.forEach(button => {
                const buttonText = button.textContent || button.innerText;
                if (buttonText.includes('分析进行中') || buttonText.includes('分析中')) {
                    isProcessing = true;
                }
            });
            
            if (spinnerButton || isProcessing) {
                console.log('📊 检测到分析正在进行中，确保按钮保持禁用状态');
                // 分析正在进行中，确保相关按钮保持禁用状态
                const arxivIdElement = analysisSection.querySelector('[data-arxiv-id]');
                if (arxivIdElement) {
                    const arxivId = arxivIdElement.getAttribute('data-arxiv-id');
                    if (arxivId) {
                        // 禁用页面中的所有开始分析按钮
                        const startButtons = document.querySelectorAll('.start-deep-analysis[data-arxiv-id="' + arxivId + '"]');
                        startButtons.forEach(button => {
                            if (button && !button.disabled) {
                                button.disabled = true;
                                button.classList.add('disabled');
                                console.log('🔒 禁用了开始分析按钮');
                            }
                        });
                    }
                }
            }
        }
    }
    
    // ===== 其他功能函数 =====
    
    // 更新评分预览
    function updateScorePreview() {
        const score = parseFloat($('#relevance-score-input').val());
        const preview = $('#score-preview');
        
        if (isNaN(score) || score < 0 || score > 1) {
            preview.html('<span class="text-muted">☆☆☆☆☆</span>');
            return;
        }
        
        const starsCount = Math.round(score * 5);
        const filledStars = '★'.repeat(starsCount);
        const emptyStars = '☆'.repeat(5 - starsCount);
        
        let colorClass;
        if (score >= 0.8) colorClass = 'text-success';
        else if (score >= 0.5) colorClass = 'text-warning';
        else colorClass = 'text-danger';
        
        preview.html(`<span class="${colorClass}">${filledStars}${emptyStars}</span> (${score.toFixed(2)})`);
    }
    
    // 更新字符计数
    function updateCharCount() {
        const text = $('#relevance-justification-input').val();
        $('#char-count').text(text.length);
    }
    
    // 理由模板
    const templates = {
        method: "该论文提出的方法与我们的研究方向高度相关，可以作为重要参考。",
        domain: "论文涉及的研究领域与当前项目需求匹配，具有较好的参考价值。",
        application: "论文中的应用场景与我们的目标应用相似，可提供有用的实践经验。",
        irrelevant: "经过分析，该论文与当前研究需求相关性较低，不符合项目要求。"
    };
    
    // 保存相关度
    function saveRelevance() {
        const arxivId = $('#edit-arxiv-id').val();
        const score = $('#relevance-score-input').val();
        const justification = $('#relevance-justification-input').val().trim();
        
        // 验证输入
        if (!score && !justification) {
            showSaveStatus('error', '请至少填写评分或理由');
            return;
        }
        
        if (score && (parseFloat(score) < 0 || parseFloat(score) > 1)) {
            showSaveStatus('error', '评分必须在0-1之间');
            return;
        }
        
        const saveBtn = $('#save-relevance-btn');
        const originalText = saveBtn.html();
        saveBtn.html('<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> 保存中...').prop('disabled', true);
        
        // 准备数据
        const data = {
            arxiv_id: arxivId
        };
        
        if (score) {
            data.relevance_score = parseFloat(score);
        }
        
        if (justification) {
            data.relevance_justification = justification;
        }
        
        // 发送请求
        $.ajax({
            url: '/api/update_relevance',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showSaveStatus('success', '保存成功！页面将刷新...');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showSaveStatus('error', response.error || '保存失败');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '网络错误，请稍后重试';
                showSaveStatus('error', error);
            },
            complete: function() {
                saveBtn.html(originalText).prop('disabled', false);
            }
        });
    }
    
    // 显示保存状态
    function showSaveStatus(type, message) {
        const statusDiv = $('#save-status');
        const messageSpan = $('#save-message');
        
        statusDiv.removeClass('alert-info alert-success alert-danger d-none');
        
        if (type === 'success') {
            statusDiv.addClass('alert-success');
            messageSpan.html(`<i class="bi bi-check-circle"></i> ${message}`);
        } else if (type === 'error') {
            statusDiv.addClass('alert-danger');
            messageSpan.html(`<i class="bi bi-exclamation-triangle"></i> ${message}`);
        } else {
            statusDiv.addClass('alert-info');
            messageSpan.html(`<i class="bi bi-info-circle"></i> ${message}`);
        }
    }
    
    // 页面加载完成后的事件绑定
    $(document).ready(function() {
        // 检查页面加载时的深度分析状态
        checkAndDisableIfProcessing();
        
        // 快捷评分按钮点击事件
        $('[data-score]').click(function() {
            const score = $(this).data('score');
            $('#relevance-score-input').val(score);
            updateScorePreview();
        });
        
        // 理由模板按钮点击事件
        $('[data-template]').click(function() {
            const template = $(this).data('template');
            const textarea = $('#relevance-justification-input');
            const currentText = textarea.val().trim();
            const templateText = templates[template];
            
            if (currentText && !confirm('这将替换当前的理由内容，确定继续吗？')) {
                return;
            }
            
            textarea.val(templateText);
            updateCharCount();
        });
        
        // 评分输入变化事件
        $('#relevance-score-input').on('input', function() {
            updateScorePreview();
        });
        
        // 理由文本变化事件
        $('#relevance-justification-input').on('input', function() {
            updateCharCount();
        });
        
        // 保存按钮点击事件
        $('#save-relevance-btn').click(function() {
            saveRelevance();
        });
        
        // 键盘快捷键
        $('#relevanceEditModal').on('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveRelevance();
            }
        });
        
        // 自定义提示词输入框事件监听
        const customPromptInput = document.getElementById('customPromptInput');
        if (customPromptInput) {
            // 输入时更新字符计数
            customPromptInput.addEventListener('input', updatePromptCharCount);
            
            // 初始化字符计数
            updatePromptCharCount();
        }
    });

    // Dify 知识库操作函数
    function uploadPaperToDify(arxivId) {
        const uploadSection = document.getElementById('dify-upload-section');
        const originalContent = uploadSection.innerHTML;
        
        // 显示上传状态
        uploadSection.innerHTML = `
            <button class="btn btn-info" disabled>
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">上传中...</span>
                </div>
                正在上传到知识库...
            </button>
        `;
        
        fetch(`/api/dify_upload/${arxivId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('论文上传成功！', 'success');
                // 更新页面显示为已上传状态
                uploadSection.innerHTML = `
                    <button class="btn btn-success" disabled>
                        <i class="bi bi-cloud-check"></i> 已上传到知识库
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('${arxivId}')">
                        <i class="bi bi-shield-check"></i> 验证文档
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="removePaperFromDify('${arxivId}')">
                        <i class="bi bi-trash"></i> 从知识库移除
                    </button>
                `;
                
                // 自动验证文档是否真正上传成功
                setTimeout(() => {
                    verifyDifyDocument(arxivId, true);
                }, 2000);
            } else {
                showAlert(`上传失败: ${data.error}`, 'error');
                // 恢复原始状态
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('上传失败:', error);
            showAlert('上传过程中发生网络错误', 'error');
            // 恢复原始状态
            uploadSection.innerHTML = originalContent;
        });
    }
    
    function removePaperFromDify(arxivId) {
        if (!confirm('确定要从知识库中移除这篇论文吗？此操作不可撤销。')) {
            return;
        }
        
        const uploadSection = document.getElementById('dify-upload-section');
        const originalContent = uploadSection.innerHTML;
        
        // 显示移除状态
        uploadSection.innerHTML = `
            <button class="btn btn-warning" disabled>
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">移除中...</span>
                </div>
                正在从知识库移除...
            </button>
        `;
        
        fetch(`/api/dify_remove/${arxivId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('论文已从知识库移除', 'success');
                // 更新页面显示
                uploadSection.innerHTML = `
                    <button class="btn btn-outline-success" onclick="uploadPaperToDify('${arxivId}')">
                        <i class="bi bi-cloud-upload"></i> 上传到知识库
                    </button>
                `;
            } else {
                showAlert(`移除失败: ${data.error}`, 'error');
                // 恢复原始状态
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('移除失败:', error);
            showAlert('移除过程中发生网络错误', 'error');
            // 恢复原始状态
            uploadSection.innerHTML = originalContent;
        });
    }
    
    function verifyDifyDocument(arxivId, isAutoVerify = false) {
        console.log(`开始验证文档: ${arxivId}, 自动验证: ${isAutoVerify}`);
        
        if (!isAutoVerify) {
            // 显示验证说明对话框
            const confirmMessage = `确定要验证这篇论文在 Dify 服务器上的状态吗？\n\n验证将检查：\n• 文档是否真实存在于 Dify 服务器\n• 文档的索引状态和字符数\n• 本地记录与服务器状态的一致性`;
            if (!confirm(confirmMessage)) {
                console.log('用户取消了验证操作');
                return;
            }
        }
        
        const uploadSection = document.getElementById('dify-upload-section');
        if (!uploadSection) {
            console.error('找不到dify-upload-section元素');
            showAlert('页面元素异常，请刷新页面重试', 'error');
            return;
        }
        
        const originalContent = uploadSection.innerHTML;
        
        // 显示更清晰的验证状态
        uploadSection.innerHTML = `
            <div class="text-center p-3 border rounded bg-light">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">验证中...</span>
                </div>
                <div class="fw-bold text-primary">正在验证文档状态...</div>
                <small class="text-muted">连接 Dify 服务器验证文档存在性</small>
            </div>
        `;
        
        console.log(`发送验证请求到: /api/dify_verify/${arxivId}`);
        
        fetch(`/api/dify_verify/${arxivId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('收到响应，状态码:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('验证响应数据:', data);
            
            if (data.success) {
                const result = data.data;
                console.log('验证结果:', result);
                
                if (result.verified) {
                    // 验证成功 - 显示详细的成功信息
                    const info = result.document_info;
                    const successMessage = isAutoVerify ? 
                        '文档自动验证成功！' : 
                        `文档验证成功！\n\n验证详情：\n• 文档状态：${info?.status || '正常'}\n• 字符数：${info?.character_count || '未知'}\n• 索引状态：${info?.indexing_status || '未知'}`;
                    
                    showAlert(successMessage, 'success');
                    
                    uploadSection.innerHTML = `
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" disabled>
                                <i class="bi bi-cloud-check"></i> 已上传到知识库
                                <span class="badge bg-light text-dark ms-1">✓ 已验证</span>
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('${arxivId}')" title="重新验证文档状态">
                                    <i class="bi bi-shield-check"></i> 重新验证
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removePaperFromDify('${arxivId}')" title="从知识库移除">
                                    <i class="bi bi-trash"></i> 移除
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 如果不是自动验证，显示详细的验证结果
                    if (!isAutoVerify && info) {
                        const detailsHtml = `
                            <div class="alert alert-success mt-2" role="alert">
                                <h6><i class="bi bi-check-circle"></i> 验证结果详情</h6>
                                <ul class="mb-0">
                                    <li><strong>文档名称：</strong>${info.dify_name || '未知'}</li>
                                    <li><strong>字符数：</strong>${info.character_count || 0}</li>
                                    <li><strong>文档状态：</strong>${info.status || '未知'}</li>
                                    <li><strong>索引状态：</strong>${info.indexing_status || '未知'}</li>
                                </ul>
                            </div>
                        `;
                        uploadSection.insertAdjacentHTML('afterend', detailsHtml);
                        
                        // 3秒后自动隐藏详情
                        setTimeout(() => {
                            const detailsAlert = uploadSection.nextElementSibling;
                            if (detailsAlert && detailsAlert.classList.contains('alert-success')) {
                                detailsAlert.remove();
                            }
                        }, 8000);
                    }
                    
                } else if (result.status === 'missing') {
                    // 文档不存在 - 显示警告和解决方案
                    console.warn('文档在Dify服务器上不存在');
                    showAlert('⚠️ 验证失败：文档在 Dify 服务器上不存在！\n\n可能原因：\n• 文档已被手动删除\n• 知识库已被重置\n• 网络传输异常\n\n建议：重新上传或清理本地记录', 'warning');
                    
                    uploadSection.innerHTML = `
                        <div class="d-grid gap-2">
                            <div class="alert alert-warning mb-2" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>状态异常：</strong>服务器上不存在此文档
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="uploadPaperToDify('${arxivId}')" title="重新上传到知识库">
                                    <i class="bi bi-cloud-upload"></i> 重新上传
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="cleanMissingDifyRecord('${arxivId}')" title="清理本地错误记录">
                                    <i class="bi bi-eraser"></i> 清理记录
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="verifyDifyDocument('${arxivId}')" title="重新验证">
                                    <i class="bi bi-arrow-repeat"></i> 重试验证
                                </button>
                            </div>
                        </div>
                    `;
                    
                } else if (result.status === 'not_uploaded') {
                    // 未上传状态
                    console.info('文档尚未上传到Dify');
                    showAlert('ℹ️ 验证结果：文档尚未上传到 Dify 知识库', 'info');
                    uploadSection.innerHTML = `
                        <button class="btn btn-outline-success" onclick="uploadPaperToDify('${arxivId}')">
                            <i class="bi bi-cloud-upload"></i> 上传到知识库
                        </button>
                    `;
                } else {
                    // 未知状态
                    console.warn('未知的验证状态:', result.status);
                    showAlert(`⚠️ 验证遇到未知状态: ${result.status}\n\n建议：稍后重试或联系管理员`, 'warning');
                    uploadSection.innerHTML = originalContent;
                }
                
            } else {
                console.error('验证失败:', data.error);
                showAlert(`❌ 验证失败: ${data.error || '未知错误'}\n\n请检查网络连接或稍后重试`, 'error');
                // 恢复原始状态
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('验证请求失败:', error);
            let errorMessage;
            if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                errorMessage = '❌ 网络连接错误\n\n请检查：\n• 网络连接状态\n• Dify 服务是否正常运行\n• 防火墙设置';
            } else if (error.message.includes('500')) {
                errorMessage = '❌ 服务器内部错误\n\n请稍后重试或联系管理员';
            } else {
                errorMessage = `❌ 验证过程中发生错误\n\n错误详情：${error.message}`;
            }
            showAlert(errorMessage, 'error');
            // 恢复原始状态
            uploadSection.innerHTML = originalContent;
        });
    }
    
    function cleanMissingDifyRecord(arxivId) {
        if (!confirm('确定要清理这篇论文的 Dify 记录吗？清理后论文状态将重置为未上传。')) {
            return;
        }
        
        const uploadSection = document.getElementById('dify-upload-section');
        const originalContent = uploadSection.innerHTML;
        
        // 显示清理状态
        uploadSection.innerHTML = `
            <button class="btn btn-warning" disabled>
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">清理中...</span>
                </div>
                正在清理记录...
            </button>
        `;
        
        fetch(`/api/dify_clean/${arxivId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('记录清理成功！论文状态已重置为未上传', 'success');
                uploadSection.innerHTML = `
                    <button class="btn btn-outline-success" onclick="uploadPaperToDify('${arxivId}')">
                        <i class="bi bi-cloud-upload"></i> 上传到知识库
                    </button>
                `;
            } else {
                showAlert(`清理失败: ${data.error}`, 'error');
                // 恢复原始状态
                uploadSection.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('清理失败:', error);
            showAlert('清理过程中发生网络错误', 'error');
            // 恢复原始状态
            uploadSection.innerHTML = originalContent;
        });
    }

    // 显示提示信息函数
    function showAlert(message, type = 'success', duration = 5000) {
        // 创建提示元素
        const alert = document.createElement('div');
        alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px; max-width: 500px; animation: slideInRight 0.3s ease;';
        
        // 添加图标
        let icon = '';
        switch(type) {
            case 'success': icon = '<i class="bi bi-check-circle-fill"></i>'; break;
            case 'error': case 'danger': icon = '<i class="bi bi-exclamation-triangle-fill"></i>'; break;
            case 'warning': icon = '<i class="bi bi-exclamation-circle-fill"></i>'; break;
            case 'info': icon = '<i class="bi bi-info-circle-fill"></i>'; break;
            default: icon = '<i class="bi bi-info-circle-fill"></i>';
        }
        
        // 处理换行符
        const formattedMessage = message.replace(/\n/g, '<br>');
        
        alert.innerHTML = `
            ${icon} <span>${formattedMessage}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        // 自动删除
        setTimeout(() => {
            if (alert.parentNode) {
                alert.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }, duration);
        
        return alert;
    }

    // 导出论文数据
    /*
    function exportPaperData() {
        const paperData = {
            arxiv_id: '{{ paper.arxiv_id }}',
            title: '{{ paper.title|e }}',
            authors: '{{ paper.authors|e }}',
            abstract: '{{ paper.abstract|e }}',
            categories: '{{ paper.categories }}',
            published_date: '{{ paper.published_date }}',
            pdf_url: '{{ paper.pdf_url }}',
            processing_status: '{{ paper.processing_status }}',
            research_background: '{{ paper.research_background|e }}',
            research_objectives: '{{ paper.research_objectives|e }}',
            methods: '{{ paper.methods|e }}',
            key_findings: '{{ paper.key_findings|e }}',
            conclusions: '{{ paper.conclusions|e }}',
            limitations: '{{ paper.limitations|e }}',
            future_work: '{{ paper.future_work|e }}',
            keywords: '{{ paper.keywords|e }}',
            tags: {{ paper.tags|tojson }},
            metadata: {{ paper.metadata|tojson }},
            created_at: '{{ paper.created_at }}',
            updated_at: '{{ paper.updated_at }}'
        };
        
        const dataStr = JSON.stringify(paperData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${paperData.arxiv_id}_data.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('论文数据已导出', 'success');
    }
    */
    
    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // 如果正在编辑相关度模态框，不处理导航快捷键
        if (document.getElementById('relevanceEditModal').classList.contains('show')) {
            return;
        }
        
        // ESC 键返回列表
        if (e.key === 'Escape') {
            window.location.href = '{{ url_for("explore.papers") }}';
        }
        
        // P 键打开PDF（如果有）
        if (e.key === 'p' || e.key === 'P') {
            // {% if paper.pdf_url %}
            window.open('{{ paper.pdf_url }}', '_blank');
            // {% endif %}
        }
        
        // 左箭头键：上一篇论文
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            // {% if navigation.previous %}
            window.location.href = '{{ url_for("explore.paper_detail", arxiv_id=navigation.previous.arxiv_id) }}';
            // {% else %}
            showAlert('已是第一篇论文', 'info');
            // {% endif %}
        }
        
        // 右箭头键：下一篇论文
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            // {% if navigation.next %}
            window.location.href = '{{ url_for("explore.paper_detail", arxiv_id=navigation.next.arxiv_id) }}';
            // {% else %}
            showAlert('已是最后一篇论文', 'info');
            // {% endif %}
        }
    });
    
    // 任务迁移相关变量 (使用不同的名称避免与main.js冲突)
    let paperDetailAvailableTasks = [];
    let paperDetailFilteredTasks = [];
    let paperDetailSelectedTask = null;
    
    // 辅助函数：HTML转义
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // 辅助函数：格式化日期
    function formatDate(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        } catch (e) {
            return dateString;
        }
    }
    
    // 打开迁移模态框
    function openMigrationModal(arxivId, paperTitle) {
        document.getElementById('migrationPaperTitle').textContent = paperTitle;
        
        // 存储当前论文的arxiv_id
        window.currentMigrationArxivId = arxivId;
        
        // 重置状态
        paperDetailSelectedTask = null;
        document.getElementById('confirmMigrationBtn').disabled = true;
        hideMigrationStatus();
        
        // 加载任务列表
        loadTasksForMigration();
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('migrationModal'));
        modal.show();
    }
    
    // 加载可用于迁移的任务
    function loadTasksForMigration() {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载任务列表...</p>
            </div>
        `;
        
        fetch('/api/tasks/available_for_migration')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    paperDetailAvailableTasks = data.data.tasks || [];
                    paperDetailFilteredTasks = [...paperDetailAvailableTasks];
                    renderTaskList();
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            加载任务列表失败: ${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('加载任务列表失败:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        网络错误，请检查网络连接后重试
                    </div>
                `;
            });
    }
    
    // 渲染任务列表
    function renderTaskList() {
        const container = document.getElementById('taskListContainer');
        
        if (paperDetailFilteredTasks.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    ${paperDetailAvailableTasks.length === 0 ? '暂无可用任务' : '搜索结果为空'}
                </div>
            `;
            return;
        }
        
        const tasksHtml = paperDetailFilteredTasks.map(task => `
            <div class="task-option border rounded p-3 mb-2 cursor-pointer" data-task='${JSON.stringify(task)}'>
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <strong>${escapeHtml(task.task_name)}</strong>
                            ${task.task_id ? `<span class="text-muted small">(${escapeHtml(task.task_id)})</span>` : ''}
                        </h6>
                        <div class="small text-muted">
                            <i class="bi bi-file-text"></i> ${task.paper_count || 0} 篇论文
                            ${task.top_categories && task.top_categories.length > 0 ? 
                                `<span class="ms-2"><i class="bi bi-tags"></i> ${task.top_categories.slice(0, 3).map(cat => escapeHtml(cat)).join(', ')}</span>` 
                                : ''
                            }
                        </div>
                        ${task.created_at ? `<div class="small text-muted mt-1"><i class="bi bi-calendar"></i> ${formatDate(task.created_at)}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <button class="btn btn-outline-primary btn-sm select-task-btn">选择</button>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = tasksHtml;
        
        // 添加点击事件监听器
        container.querySelectorAll('.task-option').forEach(taskElement => {
            taskElement.addEventListener('click', function() {
                selectTaskForMigration(this);
            });
        });
    }
    
    // 选择任务
    function selectTaskForMigration(taskElement) {
        // 清除之前的选择
        document.querySelectorAll('.task-option').forEach(el => {
            el.classList.remove('border-primary', 'bg-light');
            el.querySelector('.select-task-btn').textContent = '选择';
            el.querySelector('.select-task-btn').className = 'btn btn-outline-primary btn-sm select-task-btn';
        });
        
        // 高亮当前选择
        taskElement.classList.add('border-primary', 'bg-light');
        const selectBtn = taskElement.querySelector('.select-task-btn');
        selectBtn.textContent = '已选择';
        selectBtn.className = 'btn btn-primary btn-sm select-task-btn';
        
        // 存储选择的任务
        paperDetailSelectedTask = JSON.parse(taskElement.dataset.task);
        
        // 启用确认按钮
        document.getElementById('confirmMigrationBtn').disabled = false;
    }
    
    // 过滤任务列表
    function filterTasks() {
        const searchTerm = document.getElementById('taskSearchInput').value.toLowerCase().trim();
        paperDetailFilteredTasks = paperDetailAvailableTasks.filter(task => 
            task.task_name.toLowerCase().includes(searchTerm) ||
            (task.task_id && task.task_id.toLowerCase().includes(searchTerm)) ||
            (task.top_categories && task.top_categories.some(cat => cat.toLowerCase().includes(searchTerm)))
        );
        renderTaskList();
        
        // 清除选择状态
        paperDetailSelectedTask = null;
        document.getElementById('confirmMigrationBtn').disabled = true;
    }
    
    // 确认迁移
    function confirmMigration() {
        if (!paperDetailSelectedTask || !window.currentMigrationArxivId) {
            showMigrationStatus('error', '请先选择一个任务');
            return;
        }
        
        const confirmBtn = document.getElementById('confirmMigrationBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> 迁移中...';
        confirmBtn.disabled = true;
        
        fetch('/api/migrate_paper_to_task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                arxiv_id: window.currentMigrationArxivId,
                target_task_name: paperDetailSelectedTask.task_name,
                target_task_id: paperDetailSelectedTask.task_id || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMigrationStatus('success', '论文迁移成功！页面将刷新...');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showMigrationStatus('error', data.error || '迁移失败');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('迁移请求失败:', error);
            showMigrationStatus('error', '网络错误，请稍后重试');
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
    }
    
    // 显示迁移状态
    function showMigrationStatus(type, message) {
        const statusDiv = document.getElementById('migrationStatus');
        const messageSpan = document.getElementById('migrationStatusMessage');
        
        statusDiv.className = 'alert mt-3';
        
        if (type === 'success') {
            statusDiv.classList.add('alert-success');
            messageSpan.innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;
        } else if (type === 'error') {
            statusDiv.classList.add('alert-danger');
            messageSpan.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${message}`;
        } else {
            statusDiv.classList.add('alert-info');
            messageSpan.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
        }
    }
    
    // 隐藏迁移状态
    function hideMigrationStatus() {
        const statusDiv = document.getElementById('migrationStatus');
        statusDiv.className = 'alert d-none mt-3';
    }
    
    // 工具函数：HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // 工具函数：格式化日期
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch {
            return dateString;
        }
    }

    // 复制到剪贴板
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('已复制到剪贴板', 'success', 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            fallbackCopyTextToClipboard(text);
        }
    }
    
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showAlert('已复制到剪贴板', 'success', 2000);
            } else {
                showAlert('复制失败，请手动复制', 'error');
            }
        } catch (err) {
            console.error('复制失败:', err);
            showAlert('复制失败，请手动复制', 'error');
        }
        
        document.body.removeChild(textArea);
    }

    // 测试函数 - 验证JavaScript是否正常工作
    function testDeepAnalysisButton(arxivId) {
        console.log('测试函数被调用了！');
        alert('JavaScript正常工作！arxivId: ' + arxivId);
    }
    
    // 全局函数检查
    window.testGlobalFunction = function() {
        console.log('全局函数检查通过');
        return true;
    };
    
    // 页面加载完成后检查函数是否存在
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 页面加载完成');
        console.log('window.startDeepAnalysis存在:', typeof window.startDeepAnalysis === 'function');
        console.log('window.cancelDeepAnalysis存在:', typeof window.cancelDeepAnalysis === 'function');
        
        // 检查深度分析按钮是否存在
        const deepAnalysisSection = document.getElementById('deep-analysis-section');
        if (deepAnalysisSection) {
            console.log('✅ 找到深度分析区域');
            const buttons = deepAnalysisSection.querySelectorAll('button, a');
            console.log('找到按钮数量:', buttons.length);
            buttons.forEach((btn, index) => {
                console.log(`按钮${index + 1}:`, btn.textContent.trim(), 'onclick:', btn.onclick ? 'function' : btn.getAttribute('onclick'));
            });
        } else {
            console.error('❌ 未找到deep-analysis-section元素');
        }
        
        // 测试全局函数是否可调用
        if (typeof window.startDeepAnalysis === 'function') {
            console.log('✅ window.startDeepAnalysis 可用');
        } else {
            console.error('❌ window.startDeepAnalysis 不可用');
        }
    });
</script>
{% endblock %}
