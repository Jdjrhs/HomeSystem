{% extends "base.html" %}

{% block title %}模型设置 - PaperAnalysis{% endblock %}

{% block extra_head %}
<style>
.config-section {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin-bottom: 30px;
}

.form-help {
    font-size: 0.875rem;
    color: #6c757d;
}

.slider-container {
    padding: 10px 0;
}

.range-input {
    width: 100%;
}

.range-value {
    font-weight: bold;
    color: #007bff;
}

.settings-card {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 2rem;
}

.settings-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 1.5rem;
    margin-bottom: 0;
}

.settings-body {
    padding: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-sliders me-2"></i>模型设置</h1>
                <p class="text-muted">配置系统使用的LLM模型和深度分析参数</p>
            </div>
        </div>
    </div>
</div>

<form id="settingsForm">
    <!-- LLM模型配置卡片 -->
    <div class="settings-card">
        <div class="settings-header">
            <h4 class="mb-0"><i class="fas fa-brain me-2"></i>LLM模型配置</h4>
        </div>
        <div class="settings-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>说明：</strong>这里配置的模型将被论文浏览页面的"开始深度分析"功能和深度分析报告页面的"重新分析"功能共同使用。
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="llm_model_name" class="form-label">默认LLM模型 *</label>
                    <select class="form-select" id="llm_model_name" name="llm_model_name" required>
                        {% if available_models %}
                            {% for model in available_models %}
                            <option value="{{ model }}" 
                                    {% if model == default_config.llm_model_name %}selected{% endif %}>
                                {{ model }}
                            </option>
                            {% endfor %}
                        {% else %}
                            <option value="">加载中...</option>
                        {% endif %}
                    </select>
                    <div class="form-help">选择用于论文分析的默认语言模型</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="relevance_threshold" class="form-label">相关性阈值</label>
                    <div class="slider-container">
                        <input type="range" class="form-range range-input" id="relevance_threshold" 
                               name="relevance_threshold" min="0" max="1" step="0.1" 
                               value="{{ default_config.relevance_threshold if default_config else '0.7' }}">
                        <div class="d-flex justify-content-between">
                            <small>0.0</small>
                            <span class="range-value" id="relevance_value">{{ default_config.relevance_threshold if default_config else '0.7' }}</span>
                            <small>1.0</small>
                        </div>
                    </div>
                    <div class="form-help">只有超过此相关性分数的论文才会被保留</div>
                </div>
            </div>
            
            <!-- 高级模型配置 -->
            <div class="mt-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable_advanced_models">
                    <label class="form-check-label" for="enable_advanced_models">
                        <strong>启用高级模型配置</strong>
                    </label>
                </div>
                <div class="form-help">对不同分析任务使用专门的模型</div>
            </div>
            
            <div id="advanced_models_section" class="mt-3" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-cogs me-2"></i>专用模型配置</h6>
                        <p class="text-muted small mb-3">为不同分析任务选择专门的模型。留空则使用默认模型。</p>
                        <div class="alert alert-success small mb-3">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>重要：</strong>这里设置的"深度分析模型"和"视觉模型"将被论文浏览和深度分析报告页面的分析功能使用。
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="abstract_analysis_model" class="form-label">摘要分析模型</label>
                                <select class="form-select" id="abstract_analysis_model" name="abstract_analysis_model">
                                    <option value="">使用默认模型</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">用于初步摘要相关性分析</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="full_paper_analysis_model" class="form-label">完整论文分析模型</label>
                                <select class="form-select" id="full_paper_analysis_model" name="full_paper_analysis_model">
                                    <option value="">使用默认模型</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">用于完整论文深度分析</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="deep_analysis_model" class="form-label">深度分析模型</label>
                                <select class="form-select" id="deep_analysis_model" name="deep_analysis_model">
                                    <option value="">使用默认模型 (deepseek.DeepSeek_V3)</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">用于论文深度分析和结构化提取</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vision_model" class="form-label">视觉模型</label>
                                <select class="form-select" id="vision_model" name="vision_model">
                                    <option value="">使用默认模型 (ollama.Qwen2_5_VL_7B)</option>
                                    {% if available_models %}
                                        {% for model in available_models %}
                                        <option value="{{ model }}">{{ model }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-help">用于图像和图表识别分析</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 深度分析配置卡片 -->
    <div class="settings-card">
        <div class="settings-header">
            <h4 class="mb-0"><i class="fas fa-microscope me-2"></i>深度分析配置</h4>
        </div>
        <div class="settings-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>注意：</strong>深度分析和视觉模型的选择在上方的"LLM模型配置"中的高级模型配置部分进行设置。这里主要配置分析参数和阈值。
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enable_deep_analysis" 
                               name="enable_deep_analysis" checked>
                        <label class="form-check-label" for="enable_deep_analysis">
                            <strong>启用深度分析</strong>
                        </label>
                    </div>
                    <div class="form-help">对高相关性论文进行深度分析和结构化提取</div>
                    
                    <div id="deep_analysis_options" class="mt-3">
                        <label for="deep_analysis_threshold" class="form-label">深度分析阈值</label>
                        <div class="slider-container">
                            <input type="range" class="form-range range-input" id="deep_analysis_threshold" 
                                   name="deep_analysis_threshold" min="0" max="1" step="0.1" value="0.8">
                            <div class="d-flex justify-content-between">
                                <small>0.0</small>
                                <span class="range-value" id="deep_analysis_value">0.8</span>
                                <small>1.0</small>
                            </div>
                        </div>
                        <div class="form-help">相关性分数超过此值的论文会进行深度分析</div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="ocr_char_limit_for_analysis" class="form-label">OCR字符限制</label>
                    <input type="number" class="form-control" id="ocr_char_limit_for_analysis" 
                           name="ocr_char_limit_for_analysis" value="10000" 
                           min="1000" max="50000" step="1000">
                    <div class="form-help">用于LLM分析的最大OCR字符数（默认10000字符）</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="analysis_timeout" class="form-label">分析超时时间 (秒)</label>
                    <input type="number" class="form-control" id="analysis_timeout" name="analysis_timeout" 
                           min="300" max="1800" value="600" required>
                    <div class="form-help">单个论文深度分析的最大等待时间</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 保存按钮 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">保存设置</h5>
                            <p class="mb-0 text-muted">修改后的配置将应用到后续的任务执行中</p>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetSettings()">
                                <i class="fas fa-undo me-1"></i>重置
                            </button>
                            <button type="submit" class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save me-1"></i>保存设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- 结果提示模态框 -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">设置结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 滑块值更新
    $('#relevance_threshold').on('input', function() {
        $('#relevance_value').text($(this).val());
    });

    $('#deep_analysis_threshold').on('input', function() {
        $('#deep_analysis_value').text($(this).val());
    });

    // 深度分析开关
    $('#enable_deep_analysis').change(function() {
        if ($(this).is(':checked')) {
            $('#deep_analysis_options').show();
        } else {
            $('#deep_analysis_options').hide();
        }
    });

    // 高级模型配置开关
    $('#enable_advanced_models').change(function() {
        if ($(this).is(':checked')) {
            $('#advanced_models_section').show();
        } else {
            $('#advanced_models_section').hide();
            // 清空高级配置选择
            $('#abstract_analysis_model, #full_paper_analysis_model, #deep_analysis_model, #vision_model').val('');
        }
    });

    // 表单提交
    $('#settingsForm').submit(function(e) {
        e.preventDefault();
        saveSettings();
    });

    // 加载可用模型列表（如果模板中没有加载）
    if ($('#llm_model_name option').length <= 1) {
        loadAvailableModels();
    }
    
    // 加载现有配置
    loadSettings();
});

function loadAvailableModels() {
    $.ajax({
        url: '/api/models',
        method: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                const modelSelects = [
                    '#llm_model_name',
                    '#abstract_analysis_model', 
                    '#full_paper_analysis_model',
                    '#deep_analysis_model',
                    '#vision_model'
                ];
                
                modelSelects.forEach(function(selectId) {
                    const select = $(selectId);
                    const currentValue = select.val();
                    
                    // 保留现有选项的第一个（默认选项）
                    const firstOption = select.find('option').first();
                    select.empty().append(firstOption);
                    
                    // 添加模型选项
                    response.data.forEach(function(model) {
                        const option = $('<option></option>');
                        option.val(model).text(model);
                        if (model === currentValue) {
                            option.prop('selected', true);
                        }
                        select.append(option);
                    });
                });
            }
        },
        error: function() {
            showResult('加载模型列表失败', false);
        }
    });
}

function saveSettings() {
    const formData = getSettingsData();
    
    $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>保存中...');
    
    $.ajax({
        url: '/api/settings/save',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                showResult('设置保存成功！', true);
            } else {
                showResult('设置保存失败: ' + response.error, false);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {error: '请求失败'};
            showResult('设置保存失败: ' + response.error, false);
        },
        complete: function() {
            $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i>保存设置');
        }
    });
}

function getSettingsData() {
    const formData = {};
    const form = document.getElementById('settingsForm');
    const formDataObj = new FormData(form);
    
    for (let [key, value] of formDataObj.entries()) {
        if (key.includes('threshold')) {
            formData[key] = parseFloat(value);
        } else if (key.includes('char_limit') || key.includes('timeout')) {
            formData[key] = parseInt(value);
        } else {
            formData[key] = value;
        }
    }
    
    // 处理复选框
    formData['enable_deep_analysis'] = $('#enable_deep_analysis').is(':checked');
    
    // 处理高级模型配置 - 空值转换为null
    const advancedModelFields = ['abstract_analysis_model', 'full_paper_analysis_model', 
                                'deep_analysis_model', 'vision_model'];
    for (const field of advancedModelFields) {
        if (!formData[field] || formData[field] === '') {
            formData[field] = null;
        }
    }
    
    return formData;
}

function resetSettings() {
    if (confirm('确定要重置所有设置为默认值吗？')) {
        // 重置表单
        document.getElementById('settingsForm').reset();
        
        // 重置滑块显示
        $('#relevance_value').text($('#relevance_threshold').val());
        $('#deep_analysis_value').text($('#deep_analysis_threshold').val());
        
        // 重置高级模型配置显示状态
        $('#enable_advanced_models').prop('checked', false);
        $('#advanced_models_section').hide();
        
        // 重置深度分析选项显示
        if (!$('#enable_deep_analysis').is(':checked')) {
            $('#deep_analysis_options').hide();
        } else {
            $('#deep_analysis_options').show();
        }
    }
}

function loadSettings() {
    $.ajax({
        url: '/api/settings/load',
        method: 'GET',
        success: function(response) {
            if (response.success && response.config && Object.keys(response.config).length > 0) {
                const config = response.config;
                
                // 填充LLM配置
                if (config.llm_model_name) {
                    $('#llm_model_name').val(config.llm_model_name);
                }
                if (config.relevance_threshold !== undefined) {
                    $('#relevance_threshold').val(config.relevance_threshold);
                    $('#relevance_value').text(config.relevance_threshold);
                }
                
                // 填充高级模型配置
                if (config.abstract_analysis_model || config.full_paper_analysis_model || 
                    config.deep_analysis_model || config.vision_model) {
                    $('#enable_advanced_models').prop('checked', true);
                    $('#advanced_models_section').show();
                    
                    if (config.abstract_analysis_model) {
                        $('#abstract_analysis_model').val(config.abstract_analysis_model);
                    }
                    if (config.full_paper_analysis_model) {
                        $('#full_paper_analysis_model').val(config.full_paper_analysis_model);
                    }
                    if (config.deep_analysis_model) {
                        $('#deep_analysis_model').val(config.deep_analysis_model);
                    }
                    if (config.vision_model) {
                        $('#vision_model').val(config.vision_model);
                    }
                }
                
                // 填充深度分析配置
                if (config.enable_deep_analysis !== undefined) {
                    $('#enable_deep_analysis').prop('checked', config.enable_deep_analysis);
                    if (config.enable_deep_analysis) {
                        $('#deep_analysis_options').show();
                    } else {
                        $('#deep_analysis_options').hide();
                    }
                }
                if (config.deep_analysis_threshold !== undefined) {
                    $('#deep_analysis_threshold').val(config.deep_analysis_threshold);
                    $('#deep_analysis_value').text(config.deep_analysis_threshold);
                }
                if (config.ocr_char_limit_for_analysis !== undefined) {
                    $('#ocr_char_limit_for_analysis').val(config.ocr_char_limit_for_analysis);
                }
                if (config.analysis_timeout !== undefined) {
                    $('#analysis_timeout').val(config.analysis_timeout);
                }
                
                console.log('设置加载成功:', config);
            }
        },
        error: function(xhr) {
            console.warn('加载设置失败:', xhr.responseJSON || xhr.statusText);
        }
    });
}

function showResult(message, success) {
    const alertClass = success ? 'alert-success' : 'alert-danger';
    const iconClass = success ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    
    const html = `
        <div class="alert ${alertClass}">
            <i class="${iconClass} me-2"></i>${message}
        </div>
    `;
    
    $('#resultContent').html(html);
    $('#resultModal').modal('show');
}
</script>
{% endblock %}