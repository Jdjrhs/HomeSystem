{% extends "base.html" %}

{% block title %}任务配置 - PaperGather{% endblock %}

{% block head %}
<style>
.config-section {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin-bottom: 30px;
}

.form-help {
    font-size: 0.875rem;
    color: #6c757d;
}

.execution-mode-card {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.execution-mode-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.execution-mode-card.selected {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.slider-container {
    padding: 10px 0;
}

.range-input {
    width: 100%;
}

.range-value {
    font-weight: bold;
    color: #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-cog me-2"></i>任务配置</h1>
                <p class="text-muted">配置论文收集任务的参数，支持即时执行和定时执行两种模式</p>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" id="loadHistoryTaskBtn">
                    <i class="fas fa-history me-1"></i>从历史任务加载
                </button>
                <button type="button" class="btn btn-outline-secondary" id="loadPresetBtn">
                    <i class="fas fa-bookmark me-1"></i>加载预设
                </button>
                <button type="button" class="btn btn-outline-success" id="savePresetBtn">
                    <i class="fas fa-save me-1"></i>保存预设
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 历史任务模态框 -->
<div class="modal fade" id="historyTaskModal" tabindex="-1" aria-labelledby="historyTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyTaskModalLabel">
                    <i class="fas fa-history me-2"></i>历史任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="historyStatusFilter">
                            <option value="">所有状态</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="stopped">已停止</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="historySearchInput" placeholder="搜索任务...">
                            <button class="btn btn-outline-secondary" type="button" id="refreshHistoryBtn">
                                <i class="fas fa-refresh"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="historyTaskList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 配置预设模态框 -->
<div class="modal fade" id="presetModal" tabindex="-1" aria-labelledby="presetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="presetModalLabel">
                    <i class="fas fa-bookmark me-2"></i>配置预设
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="presetList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 保存预设模态框 -->
<div class="modal fade" id="savePresetModal" tabindex="-1" aria-labelledby="savePresetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savePresetModalLabel">
                    <i class="fas fa-save me-2"></i>保存配置预设
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="savePresetForm">
                    <div class="mb-3">
                        <label for="presetName" class="form-label">预设名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="presetName" required>
                    </div>
                    <div class="mb-3">
                        <label for="presetDescription" class="form-label">描述（可选）</label>
                        <textarea class="form-control" id="presetDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmSavePresetBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<form id="taskConfigForm">
    <!-- 执行模式选择 -->
    <div class="config-section">
        <h4><i class="fas fa-play-circle me-2"></i>执行模式</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card execution-mode-card" data-mode="immediate">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-3x text-primary mb-3"></i>
                        <h5>即时执行</h5>
                        <p class="text-muted">
                            立即执行任务并返回结果<br>
                            适合一次性的论文搜索需求
                        </p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="execution_mode" 
                                   id="mode_immediate" value="immediate" checked>
                            <label class="form-check-label" for="mode_immediate">
                                选择此模式
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card execution-mode-card" data-mode="scheduled">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-3x text-success mb-3"></i>
                        <h5>定时执行</h5>
                        <p class="text-muted">
                            后台定时执行任务<br>
                            适合持续监控最新论文
                        </p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="execution_mode" 
                                   id="mode_scheduled" value="scheduled">
                            <label class="form-check-label" for="mode_scheduled">
                                选择此模式
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 定时间隔设置 -->
        <div id="scheduled_options" class="mt-3" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-stopwatch me-2"></i>定时间隔设置</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="interval_seconds" class="form-label">执行间隔（秒）</label>
                            <input type="number" class="form-control" id="interval_seconds" 
                                   name="interval_seconds" value="3600" min="300" max="86400">
                            <div class="form-help">建议间隔不少于5分钟（300秒）</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">常用间隔</label>
                            <div class="btn-group d-block" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="setInterval(1800)">30分钟</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="setInterval(3600)">1小时</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="setInterval(21600)">6小时</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setInterval(86400)">24小时</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索配置 -->
    <div class="config-section">
        <h4><i class="fas fa-search me-2"></i>搜索配置</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="search_query" class="form-label">搜索关键词 *</label>
                <input type="text" class="form-control" id="search_query" name="search_query" 
                       value="{{ default_config.search_query }}" required>
                <div class="form-help">用于在ArXiv中搜索论文的关键词</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="max_papers_per_search" class="form-label">每次搜索最大论文数</label>
                <input type="number" class="form-control" id="max_papers_per_search" 
                       name="max_papers_per_search" value="{{ default_config.max_papers_per_search }}" 
                       min="1" max="100">
                <div class="form-help">建议设置为20-50篇以平衡质量和速度</div>
            </div>
        </div>
        <div class="mb-3">
            <label for="user_requirements" class="form-label">用户需求描述 *</label>
            <textarea class="form-control" id="user_requirements" name="user_requirements" 
                      rows="3" required>{{ default_config.user_requirements }}</textarea>
            <div class="form-help">详细描述您的研究需求，LLM将根据此描述评估论文相关性</div>
        </div>
        
        <!-- 搜索模式配置 -->
        <div class="mb-3">
            <label for="search_mode" class="form-label">搜索模式</label>
            <select class="form-select" id="search_mode" name="search_mode">
                {% for mode in available_search_modes %}
                <option value="{{ mode.value }}" 
                        {% if mode.value == default_config.search_mode %}selected{% endif %}
                        data-description="{{ mode.description }}">
                    {{ mode.label }}
                </option>
                {% endfor %}
            </select>
            <div class="form-help" id="search_mode_help">{{ available_search_modes[0].description }}</div>
        </div>
        
        <!-- 日期范围搜索参数 -->
        <div id="date_range_options" class="row mb-3" style="display: none;">
            <div class="col-md-6">
                <label for="start_year" class="form-label">起始年份</label>
                <input type="number" class="form-control" id="start_year" name="start_year" 
                       min="1991" max="2024" value="2022">
                <div class="form-help">ArXiv论文起始年份（1991年开始）</div>
            </div>
            <div class="col-md-6">
                <label for="end_year" class="form-label">结束年份</label>
                <input type="number" class="form-control" id="end_year" name="end_year" 
                       min="1991" max="2024" value="2023">
                <div class="form-help">搜索的结束年份</div>
            </div>
        </div>
        
        <!-- 某年之后搜索参数 -->
        <div id="after_year_options" class="mb-3" style="display: none;">
            <div class="col-md-6">
                <label for="after_year" class="form-label">起始年份</label>
                <input type="number" class="form-control" id="after_year" name="after_year" 
                       min="1991" max="2024" value="2024">
                <div class="form-help">搜索此年份之后的论文</div>
            </div>
        </div>
    </div>

    <!-- LLM配置 -->
    <div class="config-section">
        <h4><i class="fas fa-brain me-2"></i>LLM配置</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="llm_model_name" class="form-label">默认LLM模型 *</label>
                <select class="form-select" id="llm_model_name" name="llm_model_name" required>
                    {% for model in available_models %}
                    <option value="{{ model }}" 
                            {% if model == default_config.llm_model_name %}selected{% endif %}>
                        {{ model }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-help">选择用于论文分析的默认语言模型</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="relevance_threshold" class="form-label">相关性阈值</label>
                <div class="slider-container">
                    <input type="range" class="form-range range-input" id="relevance_threshold" 
                           name="relevance_threshold" min="0" max="1" step="0.1" 
                           value="{{ default_config.relevance_threshold }}">
                    <div class="d-flex justify-content-between">
                        <small>0.0</small>
                        <span class="range-value" id="relevance_value">{{ default_config.relevance_threshold }}</span>
                        <small>1.0</small>
                    </div>
                </div>
                <div class="form-help">只有超过此相关性分数的论文才会被保留</div>
            </div>
        </div>
        
        <!-- 高级模型配置 -->
        <div class="mt-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="enable_advanced_models">
                <label class="form-check-label" for="enable_advanced_models">
                    <strong>启用高级模型配置</strong>
                </label>
            </div>
            <div class="form-help">对不同分析任务使用专门的模型</div>
        </div>
        
        <div id="advanced_models_section" class="mt-3" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-cogs me-2"></i>专用模型配置</h6>
                    <p class="text-muted small mb-3">为不同分析任务选择专门的模型。留空则使用默认模型。</p>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="abstract_analysis_model" class="form-label">摘要分析模型</label>
                            <select class="form-select" id="abstract_analysis_model" name="abstract_analysis_model">
                                <option value="">使用默认模型</option>
                                {% for model in available_models %}
                                <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-help">用于初步摘要相关性分析</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="full_paper_analysis_model" class="form-label">完整论文分析模型</label>
                            <select class="form-select" id="full_paper_analysis_model" name="full_paper_analysis_model">
                                <option value="">使用默认模型</option>
                                {% for model in available_models %}
                                <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-help">用于完整论文深度分析</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="translation_model" class="form-label">翻译模型</label>
                            <select class="form-select" id="translation_model" name="translation_model">
                                <option value="">使用默认模型</option>
                                {% for model in available_models %}
                                <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-help">用于英文到中文翻译</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="paper_analysis_model" class="form-label">论文总结模型</label>
                            <select class="form-select" id="paper_analysis_model" name="paper_analysis_model">
                                <option value="">使用默认模型</option>
                                {% for model in available_models %}
                                <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-help">用于结构化论文内容提取</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 响应控制 -->
    <div class="config-section">
        <h4><i class="fas fa-list-ol me-2"></i>响应控制</h4>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="max_papers_in_response" class="form-label">最大论文数</label>
                <input type="number" class="form-control" id="max_papers_in_response" 
                       name="max_papers_in_response" value="{{ default_config.max_papers_in_response }}" 
                       min="1" max="200">
                <div class="form-help">响应中包含的最大论文数量</div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="max_relevant_papers_in_response" class="form-label">最大相关论文数</label>
                <input type="number" class="form-control" id="max_relevant_papers_in_response" 
                       name="max_relevant_papers_in_response" value="{{ default_config.max_relevant_papers_in_response }}" 
                       min="1" max="50">
                <div class="form-help">相关论文的最大数量</div>
            </div>
        </div>
    </div>

    <!-- 处理功能 -->
    <div class="config-section">
        <h4><i class="fas fa-tools me-2"></i>处理功能</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable_paper_summarization" 
                           name="enable_paper_summarization" 
                           {% if default_config.enable_paper_summarization %}checked{% endif %}>
                    <label class="form-check-label" for="enable_paper_summarization">
                        启用论文总结
                    </label>
                </div>
                <div class="form-help">对高相关性论文进行详细分析和总结</div>
                
                <div id="summarization_options" class="mt-3" 
                     {% if not default_config.enable_paper_summarization %}style="display: none;"{% endif %}>
                    <label for="summarization_threshold" class="form-label">总结阈值</label>
                    <div class="slider-container">
                        <input type="range" class="form-range range-input" id="summarization_threshold" 
                               name="summarization_threshold" min="0" max="1" step="0.1" 
                               value="{{ default_config.summarization_threshold }}">
                        <div class="d-flex justify-content-between">
                            <small>0.0</small>
                            <span class="range-value" id="summarization_value">{{ default_config.summarization_threshold }}</span>
                            <small>1.0</small>
                        </div>
                    </div>
                    <div class="form-help">相关性分数超过此值的论文会被详细分析</div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable_translation" 
                           name="enable_translation" 
                           {% if default_config.enable_translation %}checked{% endif %}>
                    <label class="form-check-label" for="enable_translation">
                        启用翻译功能
                    </label>
                </div>
                <div class="form-help">将英文论文的关键内容翻译为中文</div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">准备执行任务</h5>
                            <p class="mb-0 text-muted">请检查配置参数，然后选择执行方式</p>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>重置
                            </button>
                            <button type="button" class="btn btn-outline-info me-2" onclick="validateConfig()">
                                <i class="fas fa-check me-1"></i>验证配置
                            </button>
                            <button type="submit" class="btn btn-primary" id="executeBtn">
                                <i class="fas fa-play me-1"></i>执行任务
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- 执行结果模态框 -->
<div class="modal fade" id="executionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务执行</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="executionResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="viewTaskBtn" style="display: none;">
                    查看任务状态
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑任务模态框 -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑历史任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <!-- 基本配置 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">基本配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="edit_search_query" class="form-label">搜索查询</label>
                                <input type="text" class="form-control" id="edit_search_query" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_user_requirements" class="form-label">用户需求</label>
                                <textarea class="form-control" id="edit_user_requirements" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_llm_model_name" class="form-label">LLM模型</label>
                                <select class="form-select" id="edit_llm_model_name">
                                    <option value="">选择模型...</option>
                                    <!-- 模型选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 高级配置 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">高级配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_max_papers_per_search" class="form-label">最大论文数</label>
                                        <input type="number" class="form-control" id="edit_max_papers_per_search" min="1" max="100" value="20">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_search_mode" class="form-label">搜索模式</label>
                                        <select class="form-select" id="edit_search_mode">
                                            <option value="latest">最新论文</option>
                                            <option value="relevance">相关性排序</option>
                                            <option value="date_range">日期范围</option>
                                            <option value="after_year">指定年份之后</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 日期范围配置 -->
                            <div id="edit_date_range_config" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_start_year" class="form-label">开始年份</label>
                                            <input type="number" class="form-control" id="edit_start_year" min="1991" max="2030">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_end_year" class="form-label">结束年份</label>
                                            <input type="number" class="form-control" id="edit_end_year" min="1991" max="2030">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 指定年份之后配置 -->
                            <div id="edit_after_year_config" style="display: none;">
                                <div class="mb-3">
                                    <label for="edit_after_year" class="form-label">年份之后</label>
                                    <input type="number" class="form-control" id="edit_after_year" min="1991" max="2030">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_relevance_threshold" class="form-label">
                                            相关性阈值 
                                            <span class="badge bg-secondary" id="edit_relevance_threshold_value">70%</span>
                                        </label>
                                        <input type="range" class="form-range" id="edit_relevance_threshold" min="0.1" max="1.0" step="0.1" value="0.7">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_summarization_threshold" class="form-label">
                                            摘要阈值 
                                            <span class="badge bg-secondary" id="edit_summarization_threshold_value">80%</span>
                                        </label>
                                        <input type="range" class="form-range" id="edit_summarization_threshold" min="0.1" max="1.0" step="0.1" value="0.8">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_enable_paper_summarization" checked>
                                        <label class="form-check-label" for="edit_enable_paper_summarization">
                                            启用论文摘要
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_enable_translation" checked>
                                        <label class="form-check-label" for="edit_enable_translation">
                                            启用翻译
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditedTaskBtn" onclick="HistoryTaskManager.saveEditedTask()">
                    <i class="fas fa-save me-1"></i>保存更改
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 执行模式卡片点击事件
    $('.execution-mode-card').click(function() {
        const mode = $(this).data('mode');
        $('input[name="execution_mode"][value="' + mode + '"]').prop('checked', true);
        $('.execution-mode-card').removeClass('selected');
        $(this).addClass('selected');
        
        if (mode === 'scheduled') {
            $('#scheduled_options').show();
        } else {
            $('#scheduled_options').hide();
        }
    });

    // 初始化选中状态
    $('input[name="execution_mode"]:checked').closest('.execution-mode-card').addClass('selected');

    // 滑块值更新
    $('#relevance_threshold').on('input', function() {
        $('#relevance_value').text($(this).val());
    });

    $('#summarization_threshold').on('input', function() {
        $('#summarization_value').text($(this).val());
    });

    // 论文总结开关
    $('#enable_paper_summarization').change(function() {
        if ($(this).is(':checked')) {
            $('#summarization_options').show();
        } else {
            $('#summarization_options').hide();
        }
    });

    // 高级模型配置开关
    $('#enable_advanced_models').change(function() {
        if ($(this).is(':checked')) {
            $('#advanced_models_section').show();
        } else {
            $('#advanced_models_section').hide();
            // 清空高级配置选择
            $('#abstract_analysis_model, #full_paper_analysis_model, #translation_model, #paper_analysis_model').val('');
        }
    });

    // 搜索模式选择变化
    $('#search_mode').change(function() {
        const selectedMode = $(this).val();
        updateSearchModeOptions(selectedMode);
        updateSearchModeHelp();
    });

    // 初始化搜索模式选项
    updateSearchModeOptions($('#search_mode').val());

    // 表单提交
    $('#taskConfigForm').submit(function(e) {
        e.preventDefault();
        executeTask();
    });
});

function setInterval(seconds) {
    $('#interval_seconds').val(seconds);
}

function updateSearchModeOptions(selectedMode) {
    // 隐藏所有选项
    $('#date_range_options').hide();
    $('#after_year_options').hide();
    
    // 根据选择的模式显示相应选项
    if (selectedMode === 'date_range') {
        $('#date_range_options').show();
    } else if (selectedMode === 'after_year') {
        $('#after_year_options').show();
    }
}

function updateSearchModeHelp() {
    const selectedOption = $('#search_mode option:selected');
    const description = selectedOption.data('description');
    $('#search_mode_help').text(description);
}

function resetForm() {
    if (confirm('确定要重置所有配置吗？')) {
        document.getElementById('taskConfigForm').reset();
        $('.execution-mode-card').removeClass('selected');
        $('input[name="execution_mode"]:checked').closest('.execution-mode-card').addClass('selected');
        $('#relevance_value').text($('#relevance_threshold').val());
        $('#summarization_value').text($('#summarization_threshold').val());
        
        // 重置高级模型配置显示状态
        $('#enable_advanced_models').prop('checked', false);
        $('#advanced_models_section').hide();
        
        // 重置其他开关状态
        if (!$('#enable_paper_summarization').is(':checked')) {
            $('#summarization_options').hide();
        }
        
        // 重置搜索模式选项
        updateSearchModeOptions($('#search_mode').val());
        updateSearchModeHelp();
    }
}

function validateConfig() {
    const formData = getFormData();
    
    $.ajax({
        url: '/config/validate',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                showAlert('配置验证通过！', 'success');
            } else {
                showAlert('配置验证失败: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('验证请求失败', 'danger');
        }
    });
}

function executeTask() {
    const formData = getFormData();
    const mode = $('input[name="execution_mode"]:checked').val();
    
    $('#executeBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>执行中...');
    
    $.ajax({
        url: '/task/execute',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            mode: mode,
            config: formData
        }),
        success: function(response) {
            if (response.success) {
                showExecutionResult(response, true);
            } else {
                showExecutionResult(response, false);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON || {error: '请求失败'};
            showExecutionResult(response, false);
        },
        complete: function() {
            $('#executeBtn').prop('disabled', false).html('<i class="fas fa-play me-1"></i>执行任务');
        }
    });
}

function getFormData() {
    const formData = {};
    const form = document.getElementById('taskConfigForm');
    const formDataObj = new FormData(form);
    
    for (let [key, value] of formDataObj.entries()) {
        if (key === 'enable_paper_summarization' || key === 'enable_translation') {
            formData[key] = true;
        } else if (key.includes('threshold') || key === 'relevance_threshold' || key === 'summarization_threshold') {
            formData[key] = parseFloat(value);
        } else if (key.includes('max_') || key.includes('interval_') || key.includes('_year')) {
            formData[key] = parseInt(value);
        } else {
            formData[key] = value;
        }
    }
    
    // 处理未选中的复选框
    if (!$('#enable_paper_summarization').is(':checked')) {
        formData['enable_paper_summarization'] = false;
    }
    if (!$('#enable_translation').is(':checked')) {
        formData['enable_translation'] = false;
    }
    
    // 处理高级模型配置 - 空值转换为null，让后端使用默认模型
    const advancedModelFields = ['abstract_analysis_model', 'full_paper_analysis_model', 
                                'translation_model', 'paper_analysis_model'];
    for (const field of advancedModelFields) {
        if (!formData[field] || formData[field] === '') {
            formData[field] = null;
        }
    }
    
    // 处理搜索模式相关参数 - 根据搜索模式决定哪些参数有效
    const searchMode = formData['search_mode'];
    if (searchMode !== 'date_range') {
        formData['start_year'] = null;
        formData['end_year'] = null;
    }
    if (searchMode !== 'after_year') {
        formData['after_year'] = null;
    }
    
    return formData;
}

function showExecutionResult(response, success) {
    let html = '';
    if (success) {
        html = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>任务执行成功</h6>
                <p class="mb-1">${response.message}</p>
                <small>任务ID: ${response.task_id}</small>
            </div>
        `;
        $('#viewTaskBtn').show().data('task-id', response.task_id);
    } else {
        html = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-circle me-2"></i>任务执行失败</h6>
                <p class="mb-0">${response.error}</p>
            </div>
        `;
        $('#viewTaskBtn').hide();
    }
    
    $('#executionResult').html(html);
    $('#executionModal').modal('show');
}

function showAlert(message, type) {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('main .container-fluid').prepend(alert);
}

// 查看任务状态按钮
$(document).on('click', '#viewTaskBtn', function() {
    const taskId = $(this).data('task-id');
    window.open('/task/status/' + taskId, '_blank');
});

// 编辑模态框事件处理
$('#edit_search_mode').change(function() {
    const mode = $(this).val();
    HistoryTaskManager.updateEditSearchModeFields(mode);
});

// 编辑表单阈值滑块事件
$('#edit_relevance_threshold').on('input', function() {
    const value = (parseFloat($(this).val()) * 100).toFixed(0);
    $('#edit_relevance_threshold_value').text(value + '%');
});

$('#edit_summarization_threshold').on('input', function() {
    const value = (parseFloat($(this).val()) * 100).toFixed(0);
    $('#edit_summarization_threshold_value').text(value + '%');
});

// 当编辑模态框显示时，加载模型列表
$('#editTaskModal').on('show.bs.modal', function() {
    // 加载模型列表
    $.get('/api/models')
        .then(response => {
            if (response.success) {
                const modelSelect = $('#edit_llm_model_name');
                modelSelect.empty().append('<option value="">选择模型...</option>');
                
                response.data.forEach(model => {
                    modelSelect.append(`<option value="${model.id}">${model.name}</option>`);
                });
            }
        })
        .catch(error => {
            console.error('加载模型列表失败:', error);
        });
});
</script>

<!-- 引入配置页面专用的JavaScript -->
<script src="{{ url_for('static', filename='js/config.js') }}"></script>
{% endblock %}